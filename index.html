<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>중원고 공지 알리미</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f5f8fc; margin:0; padding:20px; color:#333; }
header { text-align:center; padding:20px 0; background-color:#1c3c78; color:white; }
.container { max-width:900px; margin:0 auto; }
h2 { border-bottom:2px solid #1c3c78; padding-bottom:5px; margin-top:40px; }
.card { background:white; padding:15px 20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; position:relative; }
.date { font-weight:bold; color:#1c3c78; }
.title { font-size:18px; margin:5px 0; }
.description { font-size:14px; color:#555; white-space:pre-wrap; }
.edit-btn, .delete-btn { position:absolute; top:15px; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; color:white; }
.edit-btn { right:70px; background-color:#1c3c78; }
.delete-btn { right:15px; background-color:#c0392b; }
.edit-btn:hover { background-color:#163063; }
.delete-btn:hover { background-color:#962d22; }
.add-btn { display:block; margin:20px auto; padding:10px 20px; background-color:#1c3c78; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
.add-btn:hover { background-color:#163063; }
.back-btn { margin:15px 0; padding:8px 16px; background-color:#888; color:white; border:none; border-radius:6px; cursor:pointer; }
.back-btn:hover { background-color:#555; }
textarea, input { width:100%; box-sizing:border-box; margin-top:4px; font-family:inherit; }
.file-preview { margin-top:10px; }
.file-preview img { max-width:200px; border-radius:6px; margin-top:5px; display:block; }
.file-link { display:inline-block; margin-top:5px; color:#1c3c78; text-decoration:underline; }
.hidden { display:none; }
</style>
</head>
<body>
<header>
<h1>중원고 행사·수행평가 알리미</h1>
<p>오늘의 공지사항을 빠르게 확인하세요</p>
</header>

<!-- 반 선택 화면 -->
<div id="class-select" class="container">
<h2>자신의 반을 입력하세요</h2>
<p>👉 띄어쓰기 없이 입력하세요 (예: 1학년7반)</p>
<input type="text" id="class-input" placeholder="예: 1학년7반">
<button id="class-confirm-btn">확인</button>
</div>

<!-- 공지 화면 -->
<div class="container hidden" id="main-container">
<button class="back-btn" id="back-btn">← 이전으로</button>
<button class="add-btn" id="add-general-btn">+ 공지 추가하기</button>
<h2>📅 오늘의 행사</h2>
<div id="notice-list"></div>
<h2 id="class-title">📝 수행평가</h2>
<button class="add-btn" id="add-class-btn">+ 수행평가 추가하기</button>
<div id="class-notice-list"></div>
</div>

<!-- 공지 추가 폼 -->
<div id="add-form" class="container hidden">
<h2>📌 새 공지 추가</h2>
<input type="text" id="add-date" placeholder="날짜 (예: 2025-07-25)">
<input type="text" id="add-title" placeholder="제목">
<textarea id="add-desc" placeholder="내용"></textarea>
<input type="file" id="add-file" accept=".pdf,image/*">
<br><br>
<button class="add-btn" id="submit-add-btn">등록</button>
<button class="back-btn" id="cancel-add-btn">취소</button>
</div>

<script>
const PASSWORD = "0922";
let currentClass = null; 
let addingType = null; 
const socket = io();

// DOM
const classInput = document.getElementById('class-input');
const noticeList = document.getElementById('notice-list');
const classNoticeList = document.getElementById('class-notice-list');

// 화면 전환
function setClass() {
    const raw = classInput.value.trim().replace(/\s+/g,'');
    if (!/^1학년[1-9]반$/.test(raw)) { alert("형식 오류"); return; }
    currentClass = raw;
    document.getElementById("class-select").classList.add("hidden");
    document.getElementById("main-container").classList.remove("hidden");
    document.getElementById("class-title").textContent = `📝 ${currentClass} 수행평가`;
}
document.getElementById('class-confirm-btn').onclick = setClass;
document.getElementById('back-btn').onclick = () => { currentClass=null; document.getElementById("main-container").classList.add("hidden"); document.getElementById("class-select").classList.remove("hidden"); };

// 추가 폼
function openAddForm(type) {
    const pw = prompt("비밀번호 입력"); if(pw!==PASSWORD){alert("틀림"); return;}
    addingType = type;
    document.getElementById("main-container").classList.add("hidden");
    document.getElementById("add-form").classList.remove("hidden");
}
document.getElementById("add-general-btn").onclick = ()=>openAddForm("general");
document.getElementById("add-class-btn").onclick = ()=>openAddForm("class");
document.getElementById("cancel-add-btn").onclick = ()=>{
    addingType=null;
    document.getElementById("add-form").classList.add("hidden");
    document.getElementById("main-container").classList.remove("hidden");
};

// 공지 등록
document.getElementById("submit-add-btn").onclick = async ()=>{
    const date=document.getElementById("add-date").value.trim();
    const title=document.getElementById("add-title").value.trim();
    const description=document.getElementById("add-desc").value.trim();
    if(!date||!title||!description){alert("모두 입력"); return;}

    const fileInput=document.getElementById("add-file");
    let fileData=null, fileName="", fileType="";
    if(fileInput.files.length>0){
        const file=fileInput.files[0];
        fileName=file.name; fileType=file.type;
        fileData = await new Promise(resolve=>{
            const reader
