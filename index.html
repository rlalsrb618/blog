import React, { useEffect, useMemo, useState } from "react";
import {
  LineChart,
  Line,
  CartesianGrid,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

// WaterboomApp.jsx
// Single-file React component for a simple water-usage tracker
// - Uses Tailwind CSS for styling
// - Persists data to localStorage (key: "waterboom_entries")
// - Lets user add a daily entry (date + liters), view past entries, choose a date range
// - Displays a line chart of water usage
// How to use:
// 1) Create a React app (Vite or CRA). Install `recharts` and TailwindCSS.
//    npm install recharts
// 2) Make sure Tailwind is configured in your project.
// 3) Import and render <WaterboomApp /> in your App.js or main component.

const STORAGE_KEY = "waterboom_entries";

function formatDateISO(date) {
  const d = new Date(date);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function parseISO(iso) {
  // returns Date
  return new Date(iso + "T00:00:00");
}

export default function WaterboomApp() {
  const [entries, setEntries] = useState([]); // {date: 'YYYY-MM-DD', liters: number}
  const [dateInput, setDateInput] = useState(() => formatDateISO(new Date()));
  const [litersInput, setLitersInput] = useState(0);
  const [rangeStart, setRangeStart] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() - 29);
    return formatDateISO(d);
  });
  const [rangeEnd, setRangeEnd] = useState(() => formatDateISO(new Date()));

  useEffect(() => {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) setEntries(parsed);
      } catch (e) {
        console.error("Failed to parse stored entries", e);
      }
    }
  }, []);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  }, [entries]);

  function upsertEntry(date, liters) {
    setEntries((prev) => {
      const filtered = prev.filter((e) => e.date !== date);
      return [...filtered, { date, liters: Number(liters) }].sort((a, b) =>
        a.date < b.date ? -1 : 1
      );
    });
  }

  function handleAddOrUpdate(e) {
    e.preventDefault();
    if (!dateInput) return;
    const liters = Number(litersInput);
    if (Number.isNaN(liters) || liters < 0) return alert("올바른 물 사용량을 입력하세요.");
    upsertEntry(dateInput, liters);
  }

  function handleDelete(date) {
    if (!confirm(`${date}의 기록을 삭제하시겠어요?`)) return;
    setEntries((prev) => prev.filter((e) => e.date !== date));
  }

  const entriesByDate = useMemo(() => {
    const map = new Map();
    for (const e of entries) map.set(e.date, e.liters);
    return map;
  }, [entries]);

  // Build chart data for the selected range (inclusive)
  const chartData = useMemo(() => {
    if (!rangeStart || !rangeEnd) return [];
    const start = parseISO(rangeStart);
    const end = parseISO(rangeEnd);
    const days = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const iso = formatDateISO(d);
      days.push({ date: iso, liters: entriesByDate.get(iso) ?? 0 });
    }
    return days;
  }, [rangeStart, rangeEnd, entriesByDate]);

  function fillInputsFromDate(date) {
    setDateInput(date);
    setLitersInput(entriesByDate.get(date) ?? 0);
  }

  function exportCSV() {
    const header = ["date", "liters"];
    const rows = entries.map((e) => [e.date, e.liters]);
    const csv = [header, ...rows].map((r) => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `waterboom_entries_${formatDateISO(new Date())}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importCSV(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const text = reader.result;
        const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
        const parsed = lines.slice(1).map((ln) => {
          const [date, liters] = ln.split(",").map((s) => s.trim());
          return { date, liters: Number(liters) };
        });
        // merge (overwrite same-date)
        const merged = [...entries.filter((e) => !parsed.some((p) => p.date === e.date)), ...parsed]
          .sort((a, b) => (a.date < b.date ? -1 : 1));
        setEntries(merged);
        alert("CSV 가져오기 완료");
      } catch (err) {
        alert("CSV 읽기 실패: " + err.message);
      }
    };
    reader.readAsText(file);
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-sky-50 to-white p-6">
      <div className="max-w-4xl mx-auto">
        <header className="mb-6">
          <h1 className="text-3xl font-bold">Waterboom — 하루 물 사용량 기록</h1>
          <p className="text-gray-600 mt-1">하루 물 사용량을 기록하고, 옛날 기록도 확인하세요.</p>
        </header>

        <section className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <form onSubmit={handleAddOrUpdate} className="p-4 bg-white rounded-2xl shadow-sm">
            <h2 className="font-semibold mb-3">오늘/선택한 날짜 기록</h2>
            <label className="block text-sm text-gray-700">날짜</label>
            <input
              type="date"
              className="mt-1 mb-3 w-full p-2 border rounded"
              value={dateInput}
              onChange={(e) => {
                setDateInput(e.target.value);
                const existing = entriesByDate.get(e.target.value);
                if (existing !== undefined) setLitersInput(existing);
              }}
            />

            <label className="block text-sm text-gray-700">사용한 물 (리터)</label>
            <input
              type="number"
              min="0"
              step="0.1"
              className="mt-1 mb-3 w-full p-2 border rounded"
              value={litersInput}
              onChange={(e) => setLitersInput(e.target.value)}
            />

            <div className="flex gap-2">
              <button className="px-4 py-2 bg-blue-600 text-white rounded-xl">저장</button>
              <button
                type="button"
                onClick={() => {
                  setDateInput(formatDateISO(new Date()));
                  setLitersInput(0);
                }}
                className="px-4 py-2 bg-gray-100 rounded-xl"
              >
                초기화
              </button>
            </div>

            <div className="mt-4 text-sm text-gray-600">메모: 같은 날짜에 저장하면 기록이 덮어써집니다.</div>
          </form>

          <div className="p-4 bg-white rounded-2xl shadow-sm">
            <h2 className="font-semibold mb-3">차트: 선택한 기간의 물 사용량</h2>

            <div className="flex gap-2 items-center mb-3">
              <div>
                <label className="text-sm text-gray-700 block">시작</label>
                <input
                  type="date"
                  value={rangeStart}
                  onChange={(e) => setRangeStart(e.target.value)}
                  className="mt-1 p-2 border rounded"
                />
              </div>
              <div>
                <label className="text-sm text-gray-700 block">끝</label>
                <input
                  type="date"
                  value={rangeEnd}
                  onChange={(e) => setRangeEnd(e.target.value)}
                  className="mt-1 p-2 border rounded"
                />
              </div>
              <div className="ml-auto text-sm text-gray-600">총일수: {chartData.length}</div>
            </div>

            <div style={{ height: 240 }} className="bg-sky-50 p-3 rounded">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={chartData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="date" tickFormatter={(d) => d.slice(5)} />
                  <YAxis />
                  <Tooltip formatter={(val) => `${val} L`} />
                  <Line type="monotone" dataKey="liters" stroke="#0ea5e9" strokeWidth={3} dot={{ r: 3 }} />
                </LineChart>
              </ResponsiveContainer>
            </div>

            <div className="mt-3 flex gap-2">
              <button
                className="px-3 py-2 bg-green-600 text-white rounded-xl"
                onClick={() => {
                  // quick range: last 7 days
                  const end = new Date();
                  const start = new Date();
                  start.setDate(end.getDate() - 6);
                  setRangeStart(formatDateISO(start));
                  setRangeEnd(formatDateISO(end));
                }}
              >
                최근 7일
              </button>
              <button
                className="px-3 py-2 bg-indigo-600 text-white rounded-xl"
                onClick={() => {
                  const end = new Date();
                  const start = new Date();
                  start.setDate(end.getDate() - 29);
                  setRangeStart(formatDateISO(start));
                  setRangeEnd(formatDateISO(end));
                }}
              >
                최근 30일
              </button>
              <button
                className="px-3 py-2 bg-gray-100 rounded-xl"
                onClick={() => {
                  setRangeStart(entries.length ? entries[0].date : rangeStart);
                  setRangeEnd(entries.length ? entries[entries.length - 1].date : rangeEnd);
                }}
              >
                전체 기간
              </button>
            </div>
          </div>
        </section>

        <section className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="p-4 bg-white rounded-2xl shadow-sm">
            <h2 className="font-semibold mb-3">기록 목록</h2>
            <div className="overflow-auto max-h-64">
              {entries.length === 0 ? (
                <div className="text-sm text-gray-500">아직 기록이 없습니다.</div>
              ) : (
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left text-gray-600">
                      <th className="p-2">날짜</th>
                      <th className="p-2">사용량 (L)</th>
                      <th className="p-2">동작</th>
                    </tr>
                  </thead>
                  <tbody>
                    {entries
                      .slice()
                      .reverse()
                      .map((e) => (
                        <tr key={e.date} className="border-t">
                          <td className="p-2">{e.date}</td>
                          <td className="p-2">{e.liters}</td>
                          <td className="p-2">
                            <button
                              className="mr-2 px-2 py-1 bg-sky-100 rounded"
                              onClick={() => fillInputsFromDate(e.date)}
                            >
                              불러오기
                            </button>
                            <button
                              className="px-2 py-1 bg-red-100 rounded"
                              onClick={() => handleDelete(e.date)}
                            >
                              삭제
                            </button>
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>

          <div className="p-4 bg-white rounded-2xl shadow-sm">
            <h2 className="font-semibold mb-3">데이터 관리</h2>
            <div className="flex gap-2">
              <button className="px-4 py-2 bg-yellow-500 text-white rounded-xl" onClick={exportCSV}>
                CSV 내보내기
              </button>
              <label className="px-4 py-2 bg-gray-100 rounded-xl cursor-pointer">
                CSV 가져오기
                <input
                  type="file"
                  accept=".csv"
                  className="hidden"
                  onChange={(e) => {
                    const f = e.target.files?.[0];
                    if (f) importCSV(f);
                  }}
                />
              </label>
              <button
                className="px-4 py-2 bg-red-600 text-white rounded-xl ml-auto"
                onClick={() => {
                  if (!confirm("모든 기록을 완전히 삭제하시겠어요?")) return;
                  setEntries([]);
                }}
              >
                전체 삭제
              </button>
            </div>

            <div className="mt-4 text-sm text-gray-600">
              이 앱은 브라우저 로컬스토리지를 사용합니다. 다른 기기에서 동기화하려면 CSV로 내보내기/가져오기를 사용하세요.
            </div>
          </div>
        </section>

        <footer className="mt-6 text-center text-gray-500 text-sm">
          © Waterboom — 물의 중요성을 기억하세요.
        </footer>
      </div>
    </div>
  );
}
