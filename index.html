<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>중원고 공지 알리미 (개편)</title>
<style>
  :root{
    --primary:#1c3c78; --bg:#f5f8fc; --danger:#c0392b; --muted:#777;
  }
  body{font-family:'Segoe UI',system-ui,-apple-system,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:var(--bg);margin:0;color:#333}
  header{background:var(--primary);color:#fff;text-align:center;padding:24px 12px}
  .container{max-width:980px;margin:0 auto;padding:20px}
  h2{margin:24px 0 12px;border-bottom:2px solid var(--primary);padding-bottom:6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:16px 18px;margin:12px 0;position:relative}
  .date{font-weight:600;color:var(--primary)}
  .title{font-size:18px;margin:6px 0}
  .description{white-space:pre-wrap;color:#555}
  .btn{display:inline-flex;align-items:center;gap:6px;border:0;border-radius:8px;padding:9px 14px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;transition:.2s}
  .btn:hover{opacity:0.9}
  .btn.muted{background:#888}
  .btn.danger{background:var(--danger)}
  .btn.ghost{background:#e9eef8;color:#1c3c78}
  .btn + .btn{margin-left:8px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  select, input[type="text"], input[type="date"], textarea{width:100%;box-sizing:border-box;border:1px solid #d6dbe6;border-radius:8px;padding:10px 12px;font:inherit}
  textarea{min-height:120px}
  .hidden{display:none}
  .file-preview{margin-top:10px}
  .file-preview img{max-width:220px;border-radius:8px;margin-top:6px;cursor:pointer}
  .file-link{display:inline-block;margin-top:6px;color:var(--primary);text-decoration:underline}
  .grid{display:grid;gap:16px}
  @media (min-width:840px){.grid.two{grid-template-columns:1fr 1fr}}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#1c3c78;font-size:12px;font-weight:700}
  .actions{position:absolute;top:12px;right:12px}
  .actions .btn{padding:6px 10px;font-size:12px}
  .section-head{display:flex;align-items:center;justify-content:space-between}
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
  .lightbox img{max-width:95vw;max-height:90vh;border-radius:10px}
  .lightbox.show{display:flex}
  .lightbox .btn{position:absolute;top:18px;right:18px}
  .session-item{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .session-item input{flex:1}
  .help{color:var(--muted);font-size:12px;margin-top:6px}
  .stack-sm{display:grid;gap:10px}
</style>
</head>
<body>
  <header>
    <h1>중원고 행사·수행평가·반별공지 알리미</h1>
    <p>오늘의 공지사항을 빠르게 확인하세요</p>
  </header>

  <!-- 반 선택 -->
  <section id="class-select" class="container">
    <h2>자신의 반을 선택하세요</h2>
    <div class="grid two">
      <div>
        <label for="class-select-input" class="help">1학년 1~9반</label>
        <select id="class-select-input">
          <option value="" selected disabled>반 선택</option>
          <option>1학년1반</option>
          <option>1학년2반</option>
          <option>1학년3반</option>
          <option>1학년4반</option>
          <option>1학년5반</option>
          <option>1학년6반</option>
          <option>1학년7반</option>
          <option>1학년8반</option>
          <option>1학년9반</option>
        </select>
      </div>
      <div class="stack-sm">
        <button id="class-confirm-btn" class="btn">확인</button>
        <div id="debug" class="help">상태: 대기중</div>
      </div>
    </div>
  </section>

  <!-- 메인 -->
  <section id="main" class="container hidden">
    <div class="toolbar">
      <button id="nav-back" class="btn muted">← 반 다시 선택</button>
      <button id="btn-add" class="btn">+ 글 추가</button>
    </div>

    <div class="grid two">
      <div>
        <div class="section-head">
          <h2>📅 행사 (전체공통)</h2>
          <span class="badge">행사</span>
        </div>
        <div id="list-events"></div>
      </div>
      <div>
        <div class="section-head">
          <h2 id="assess-title">📝 수행평가</h2>
          <span class="badge">수행평가</span>
        </div>
        <div id="list-assessments"></div>
      </div>
    </div>

    <h2 id="class-title">📣 반별 공지</h2>
    <div id="list-class"></div>
  </section>
  <!-- 작성/수정 폼 -->
  <section id="editor" class="container hidden">
    <h2 id="editor-title">새 글</h2>
    <div class="grid two">
      <div class="stack-sm">
        <label>카테고리</label>
        <select id="f-category">
          <option value="event">행사 (전체공통)</option>
          <option value="assessment">수행평가 (내용 공통)</option>
          <option value="class">반별 공지</option>
        </select>
      </div>
      <div class="stack-sm">
        <label>날짜</label>
        <input id="f-date" type="date" />
      </div>
    </div>

    <div class="grid two">
      <div class="stack-sm"><label>제목</label><input id="f-title" type="text" placeholder="제목" /></div>
      <div class="stack-sm"><label>첨부파일 (이미지/PDF)</label><input id="f-file" type="file" accept="image/*,.pdf" /></div>
    </div>

    <div class="stack-sm" style="margin-top:12px">
      <label>내용</label>
      <textarea id="f-desc" placeholder="내용" ></textarea>
      <div id="file-preview" class="file-preview"></div>
    </div>

    <div id="session-editor" class="hidden" style="margin-top:18px">
      <div class="section-head"><h3>차시 정보 (+/-로 추가)</h3><span class="help">예시: 1차시 : 보고서 안내</span></div>
      <div id="session-list"></div>
      <div class="toolbar">
        <button id="btn-add-session" class="btn ghost">+ 차시 추가</button>
      </div>
    </div>

    <div class="toolbar">
      <button id="btn-save" class="btn">저장</button>
      <button id="btn-cancel" class="btn muted">취소</button>
    </div>
  </section>

  <!-- 반별 수행평가 차시 편집 -->
  <section id="session-panel" class="container hidden">
    <div class="section-head"><h2>차시 편집 (반별 비밀번호 필요)</h2><span class="badge" id="sp-assessment-title">-</span></div>
    <div id="class-session-list"></div>
    <div class="toolbar">
      <button id="sp-add" class="btn ghost">+ 차시 추가</button>
      <button id="sp-save" class="btn">저장</button>
      <button id="sp-cancel" class="btn muted">닫기</button>
    </div>
  </section>

  <div id="lightbox" class="lightbox"><button class="btn">닫기</button><img alt="preview" /></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ================= Firebase 설정 =================
const firebaseConfig = {
  apiKey: "AIzaSyAxyzwEpyLDxBjS9Wn2wjgzrphx4surn5g",
  authDomain: "jungwonjd2.firebaseapp.com",
  databaseURL: "https://jungwonjd2-default-rtdb.firebaseio.com",
  projectId: "jungwonjd2",
  storageBucket: "jungwonjd2.appspot.com", // ✅ 수정됨
  messagingSenderId: "197915083889",
  appId: "1:197915083889:web:5c85a163afcf7311eb07d0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============ 전역 변수 ============
let currentClass = null;
let editContext = null;
let classes = {};
let masterHash = null;
let events = [];
let assessments = [];
let classNotices = {};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const setDebug = t => { const d=$('#debug'); if(d) d.innerText=t; };

// ============ 보안 함수 ============
async function sha256Hex(str){
  if(location.protocol !== "https:")
    console.warn("⚠️ crypto.subtle은 HTTPS 환경에서만 정상 작동합니다.");
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function verifyPassword(input, hash){ return (await sha256Hex(input))===hash; }

// ============ 데이터 불러오기 ============
async function loadSecurity(){
  const sDoc = await getDoc(doc(db,"settings","master"));
  masterHash = sDoc.exists()? sDoc.data().passwordHash || null : null;
  const cSnap = await getDocs(collection(db,"classes"));
  classes = {};
  cSnap.forEach(d=>{ classes[d.id] = {...d.data()}; });
}
async function loadEvents(){
  const snap = await getDocs(collection(db,"events"));
  events = snap.docs.map(d=>({id:d.id,...d.data()}));
}
async function loadAssessments(){
  const snap = await getDocs(collection(db,"assessments"));
  assessments = snap.docs.map(d=>({id:d.id,...d.data()}));
}
async function loadClassNotices(){
  const snap = await getDocs(collection(db,"classNotices"));
  classNotices = {};
  snap.forEach(d=>{
    const c = d.data().className || "unknown";
    if(!classNotices[c]) classNotices[c] = [];
    classNotices[c].push({id:d.id,...d.data()});
  });
}
async function loadAll(){
  await loadSecurity();
  await loadEvents();
  await loadAssessments();
  await loadClassNotices();
  renderAll();
  setDebug("데이터 불러오기 완료");
}

// ============ 렌더링 함수 ============
function renderAll(){
  if(currentClass){
    $("#assess-title").textContent=`📝 수행평가 (현재: ${currentClass})`;
    $("#class-title").textContent=`📣 ${currentClass} 반별 공지`;
  }
  renderList("#list-events", events, "event");
  renderList("#list-assessments", assessments, "assessment");
  const arr = currentClass ? classNotices[currentClass] || [] : [];
  renderList("#list-class", arr, "class");
}

function renderList(sel, arr, cat){
  const box = $(sel);
  if(!box) return;
  box.innerHTML="";
  arr.sort((a,b)=>(a.date||"").localeCompare(b.date)).reverse();
  arr.forEach(n=>{
    const card = makeCard(n, cat);
    box.appendChild(card);
  });
}

function filePreviewHTML(n){
  if(!n.fileData) return "";
  if(n.fileType?.startsWith("image/"))
    return `<div class="file-preview"><img data-preview src="${n.fileData}" alt="첨부 이미지" /></div>`;
  return `<a class="file-link" href="${n.fileData}" download="${n.fileName||'file'}">📎 ${n.fileName||'첨부파일'}</a>`;
}

function makeCard(n, cat){
  const el = document.createElement("div");
  el.className="card";
  el.innerHTML=`
    <div class="date">${n.date||""}</div>
    <div class="title">${n.title||""}</div>
    <div class="description">${n.description||""}</div>
    ${filePreviewHTML(n)}
  `;
  el.querySelectorAll("img[data-preview]").forEach(img=>{
    img.addEventListener("click",()=>openLightbox(img.src));
  });
  const act=document.createElement("div");
  act.className="actions";
  const b1=document.createElement("button"); b1.className="btn"; b1.textContent="수정";
  const b2=document.createElement("button"); b2.className="btn danger"; b2.textContent="삭제";
  act.append(b1,b2);
  el.appendChild(act);
  b1.onclick=()=>openEditorForEdit(cat,n);
  b2.onclick=()=>handleDelete(cat,n);
  return el;
}

// ============ 라이트박스 ============
function openLightbox(src){
  const lb=$("#lightbox");
  lb.querySelector("img").src=src;
  lb.classList.add("show");
}
$("#lightbox .btn").onclick=()=>$("#lightbox").classList.remove("show");
$("#lightbox").addEventListener("click",e=>{
  if(e.target.id==="lightbox") $("#lightbox").classList.remove("show");
});

// 이후 내용 (편집기, 저장, 삭제, 권한, 반 선택 등) 동일 — 아래 메시지에서 3부로 이어짐
</script>
<script type="module">
// ================= 편집기 =================
const editor = $("#editor");
const fCat = $("#f-category");
const fDate = $("#f-date");
const fTitle = $("#f-title");
const fDesc = $("#f-desc");
const fFile = $("#f-file");
const previewBox = $("#file-preview");
const sessionEditor = $("#session-editor");
const sessionList = $("#session-list");

fFile.addEventListener("change",()=>{
  previewBox.innerHTML="";
  const file=fFile.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const url=e.target.result;
    if(file.type.startsWith("image/"))
      previewBox.innerHTML=`<img src="${url}" alt="미리보기" />`;
    else
      previewBox.innerHTML=`<a class="file-link" href="${url}" download="${file.name}">${file.name}</a>`;
  };
  reader.readAsDataURL(file);
});

$("#btn-add-session").onclick=()=>{
  const div=document.createElement("div");
  div.className="session-item";
  div.innerHTML=`
    <input type="text" placeholder="차시명 입력" />
    <button class="btn danger">-</button>`;
  div.querySelector("button").onclick=()=>div.remove();
  sessionList.appendChild(div);
};

function openEditorForNew(cat){
  editContext=null;
  $("#editor-title").innerText="새 글 작성";
  fCat.value=cat||"class";
  fDate.valueAsDate=new Date();
  fTitle.value=fDesc.value="";
  fFile.value="";
  previewBox.innerHTML="";
  sessionEditor.classList.toggle("hidden", fCat.value!=="assessment");
  $("#main").classList.add("hidden");
  editor.classList.remove("hidden");
}

function openEditorForEdit(cat, data){
  editContext={cat, id:data.id};
  $("#editor-title").innerText="글 수정";
  fCat.value=cat;
  fDate.value=data.date||"";
  fTitle.value=data.title||"";
  fDesc.value=data.description||"";
  previewBox.innerHTML=filePreviewHTML(data);
  sessionEditor.classList.toggle("hidden", fCat.value!=="assessment");
  $("#main").classList.add("hidden");
  editor.classList.remove("hidden");
}

$("#btn-add").onclick=()=>openEditorForNew("class");
$("#btn-cancel").onclick=()=>{
  editor.classList.add("hidden");
  $("#main").classList.remove("hidden");
};

// ============ 저장 ============
$("#btn-save").onclick=async()=>{
  const cat=fCat.value, date=fDate.value, title=fTitle.value.trim(), desc=fDesc.value.trim();
  if(!title){alert("제목을 입력하세요");return;}
  const base={date,title,description:desc,updatedAt:serverTimestamp()};
  const file=fFile.files[0];
  if(file){
    const dataURL=await new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});
    base.fileData=dataURL; base.fileName=file.name; base.fileType=file.type;
  }
  if(cat==="class" && currentClass) base.className=currentClass;

  if(editContext){
    await updateDoc(doc(db,editContext.cat==="class"?"classNotices":editContext.cat+"s", editContext.id), base);
  }else{
    const coll = cat==="class"?"classNotices":cat+"s";
    await addDoc(collection(db,coll), base);
  }
  alert("저장되었습니다!");
  editor.classList.add("hidden");
  $("#main").classList.remove("hidden");
  await loadAll();
};

// ============ 삭제 ============
async function handleDelete(cat, n){
  if(!confirm("삭제하시겠습니까?")) return;
  const coll = cat==="class"?"classNotices":cat+"s";
  await deleteDoc(doc(db,coll,n.id));
  alert("삭제 완료");
  await loadAll();
}

// ============ 반 선택 ============
$("#class-confirm-btn").onclick=()=>{
  const sel=$("#class-select-input");
  if(!sel.value){alert("반을 선택하세요!");return;}
  currentClass=sel.value;
  $("#class-select").classList.add("hidden");
  $("#main").classList.remove("hidden");
  renderAll();
};
$("#nav-back").onclick=()=>{
  $("#main").classList.add("hidden");
  $("#class-select").classList.remove("hidden");
  currentClass=null;
};

// ============ 초기 로드 ============
window.addEventListener("DOMContentLoaded",async()=>{
  setDebug("데이터 불러오는 중...");
  try{await loadAll();}catch(e){console.error(e);setDebug("⚠️ 로드 실패: "+e.message);}
});
</script>

</body>
</html>
