<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¤‘ì›ê³  ê³µì§€ ì•Œë¦¬ë¯¸ (ê°œí¸)</title>
<style>
  :root{
    --primary:#1c3c78; --bg:#f5f8fc; --danger:#c0392b; --muted:#777;
  }
  body{font-family:'Segoe UI',system-ui,-apple-system,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:var(--bg);margin:0;color:#333}
  header{background:var(--primary);color:#fff;text-align:center;padding:24px 12px}
  .container{max-width:980px;margin:0 auto;padding:20px}
  h2{margin:24px 0 12px;border-bottom:2px solid var(--primary);padding-bottom:6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:16px 18px;margin:12px 0;position:relative}
  .date{font-weight:600;color:var(--primary)}
  .title{font-size:18px;margin:6px 0}
  .description{white-space:pre-wrap;color:#555}
  .btn{display:inline-flex;align-items:center;gap:6px;border:0;border-radius:8px;padding:9px 14px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600}
  .btn.muted{background:#888}
  .btn.danger{background:var(--danger)}
  .btn.ghost{background:#e9eef8;color:#1c3c78}
  .btn + .btn{margin-left:8px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  select, input[type="text"], input[type="date"], textarea{width:100%;box-sizing:border-box;border:1px solid #d6dbe6;border-radius:8px;padding:10px 12px;font:inherit}
  textarea{min-height:120px}
  .hidden{display:none}
  .file-preview{margin-top:10px}
  .file-preview img{max-width:220px;border-radius:8px;margin-top:6px;cursor:pointer}
  .file-link{display:inline-block;margin-top:6px;color:var(--primary);text-decoration:underline}
  .grid{display:grid;gap:16px}
  @media (min-width:840px){.grid.two{grid-template-columns:1fr 1fr}}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#eef2ff;color:#1c3c78;font-size:12px;font-weight:700}
  .actions{position:absolute;top:12px;right:12px}
  .actions .btn{padding:6px 10px;font-size:12px}
  .section-head{display:flex;align-items:center;justify-content:space-between}
  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
  .lightbox img{max-width:95vw;max-height:90vh;border-radius:10px}
  .lightbox.show{display:flex}
  .lightbox .btn{position:absolute;top:18px;right:18px}
  /* Session editor */
  .session-item{display:flex;gap:8px;margin-top:8px}
  .session-item input{flex:1}
  .help{color:var(--muted);font-size:12px;margin-top:6px}
  .stack-sm{display:grid;gap:10px}
</style>
</head>
<body>
  <header>
    <h1>ì¤‘ì›ê³  í–‰ì‚¬Â·ìˆ˜í–‰í‰ê°€Â·ë°˜ë³„ê³µì§€ ì•Œë¦¬ë¯¸</h1>
    <p>ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”</p>
  </header>

  <!-- ë°˜ ì„ íƒ -->
  <section id="class-select" class="container">
    <h2>ìì‹ ì˜ ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</h2>
    <div class="grid two">
      <div>
        <label for="class-select-input" class="help">1í•™ë…„ 1~9ë°˜</label>
        <select id="class-select-input">
          <option value="" selected disabled>ë°˜ ì„ íƒ</option>
          <option>1í•™ë…„1ë°˜</option>
          <option>1í•™ë…„2ë°˜</option>
          <option>1í•™ë…„3ë°˜</option>
          <option>1í•™ë…„4ë°˜</option>
          <option>1í•™ë…„5ë°˜</option>
          <option>1í•™ë…„6ë°˜</option>
          <option>1í•™ë…„7ë°˜</option>
          <option>1í•™ë…„8ë°˜</option>
          <option>1í•™ë…„9ë°˜</option>
        </select>
      </div>
      <div class="stack-sm">
        <button id="class-confirm-btn" class="btn">í™•ì¸</button>
        <div id="debug" class="help">ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
      </div>
    </div>
  </section>

  <!-- ë©”ì¸ -->
  <section id="main" class="container hidden">
    <div class="toolbar">
      <button id="nav-back" class="btn muted">â† ë°˜ ë‹¤ì‹œ ì„ íƒ</button>
      <button id="btn-add" class="btn">+ ê¸€ ì¶”ê°€</button>
    </div>

    <div class="grid two">
      <div>
        <div class="section-head">
          <h2>ğŸ“… í–‰ì‚¬ (ì „ì²´ê³µí†µ)</h2>
          <span class="badge">í–‰ì‚¬</span>
        </div>
        <div id="list-events"></div>
      </div>
      <div>
        <div class="section-head">
          <h2 id="assess-title">ğŸ“ ìˆ˜í–‰í‰ê°€</h2>
          <span class="badge">ìˆ˜í–‰í‰ê°€</span>
        </div>
        <div id="list-assessments"></div>
      </div>
    </div>

    <h2 id="class-title">ğŸ“£ ë°˜ë³„ ê³µì§€</h2>
    <div id="list-class"></div>
  </section>

  <!-- ì‘ì„±/ìˆ˜ì • í¼ -->
  <section id="editor" class="container hidden">
    <h2 id="editor-title">ìƒˆ ê¸€</h2>
    <div class="grid two">
      <div class="stack-sm">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="f-category">
          <option value="event">í–‰ì‚¬ (ì „ì²´ê³µí†µ)</option>
          <option value="assessment">ìˆ˜í–‰í‰ê°€ (ë‚´ìš© ê³µí†µ)</option>
          <option value="class">ë°˜ë³„ ê³µì§€</option>
        </select>
      </div>
      <div class="stack-sm">
        <label>ë‚ ì§œ</label>
        <input id="f-date" type="date" />
      </div>
    </div>

    <div class="grid two">
      <div class="stack-sm"><label>ì œëª©</label><input id="f-title" type="text" placeholder="ì œëª©" /></div>
      <div class="stack-sm"><label>ì²¨ë¶€íŒŒì¼ (ì´ë¯¸ì§€/PDF)</label><input id="f-file" type="file" accept="image/*,.pdf" /></div>
    </div>

    <div class="stack-sm" style="margin-top:12px">
      <label>ë‚´ìš©</label>
      <textarea id="f-desc" placeholder="ë‚´ìš©" ></textarea>
      <div id="file-preview" class="file-preview"></div>
    </div>

    <!-- ìˆ˜í–‰í‰ê°€ ì´ˆê¸° ì°¨ì‹œ ì…ë ¥ (ì˜µì…˜) -->
    <div id="session-editor" class="hidden" style="margin-top:18px">
      <div class="section-head"><h3>ì°¨ì‹œ ì •ë³´ (+/-ë¡œ ì¶”ê°€)</h3><span class="help">ì˜ˆì‹œ: 1ì°¨ì‹œ : ë³´ê³ ì„œ ì•ˆë‚´</span></div>
      <div id="session-list"></div>
      <div class="toolbar">
        <button id="btn-add-session" class="btn ghost">+ ì°¨ì‹œ ì¶”ê°€</button>
      </div>
    </div>

    <div class="toolbar">
      <button id="btn-save" class="btn">ì €ì¥</button>
      <button id="btn-cancel" class="btn muted">ì·¨ì†Œ</button>
    </div>
  </section>

  <!-- ì°¨ì‹œ(ìˆ˜í–‰í‰ê°€) per-class í¸ì§‘ íŒ¨ë„ -->
  <section id="session-panel" class="container hidden">
    <div class="section-head"><h2>ì°¨ì‹œ í¸ì§‘ (ë°˜ë³„ ë¹„ë°€ë²ˆí˜¸ í•„ìš”)</h2><span class="badge" id="sp-assessment-title">-</span></div>
    <div id="class-session-list"></div>
    <div class="toolbar">
      <button id="sp-add" class="btn ghost">+ ì°¨ì‹œ ì¶”ê°€</button>
      <button id="sp-save" class="btn">ì €ì¥</button>
      <button id="sp-cancel" class="btn muted">ë‹«ê¸°</button>
    </div>
  </section>

  <!-- ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ -->
  <div id="lightbox" class="lightbox"><button class="btn">ë‹«ê¸°</button><img alt="preview" /></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ================= Firebase ì„¤ì • =================
const firebaseConfig = {
  apiKey: "AIzaSyAxyzwEpyLDxBjS9Wn2wjgzrphx4surn5g",
  authDomain: "jungwonjd2.firebaseapp.com",
  databaseURL: "https://jungwonjd2-default-rtdb.firebaseio.com",
  projectId: "jungwonjd2",
  storageBucket: "jungwonjd2.firebasestorage.app",
  messagingSenderId: "197915083889",
  appId: "1:197915083889:web:5c85a163afcf7311eb07d0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= ì „ì—­ ìƒíƒœ =================
let currentClass = null;
let editContext = null; // {mode:'create'|'edit', category, col, id}
let classes = {};       // {"1í•™ë…„1ë°˜": {passwordHash:"..."}, ...}
let masterHash = null;  // settings/master.passwordHash

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const setDebug = t => ($('#debug')||{}).innerText = t;

// crypto utils (SHA-256 to hex)
async function sha256Hex(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function verifyPassword(input, hash){
  const h = await sha256Hex(input);
  return h === hash;
}

// =============== ë°ì´í„° ë¡œë“œ ===============
async function loadSecurity(){
  // load master
  const sDoc = await getDoc(doc(db,'settings','master'));
  masterHash = sDoc.exists()? (sDoc.data().passwordHash||null) : null;
  // load classes
  const cSnap = await getDocs(collection(db,'classes'));
  classes = {};
  cSnap.forEach(d=>{ classes[d.id] = { ...(d.data()) }; });
}

async function loadAll(){
  await Promise.all([loadSecurity(), loadEvents(), loadAssessments(), loadClassNotices()]);
  renderAll();
  setDebug('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
}

// Collections:
// events (ì „ì²´ê³µí†µ)
// assessments (ê³µí†µ ë³¸ë¬¸) {date,title,description,defaultSessions:[{order,text}], file{ name,type,data }}
//   assessments/{id}/sessions/{className} { items:[{order,text}] }
// classNotices (ë°˜ë³„) {className, date,title,description, file}

let events = [];
let assessments = []; // {id, ...}
let classNotices = {}; // {className: [notice,...]}

async function loadEvents(){
  events = [];
  const snap = await getDocs(collection(db,'events'));
  snap.forEach(d=>events.push({id:d.id, ...d.data()}));
}
async function loadAssessments(){
  assessments = [];
  const snap = await getDocs(collection(db,'assessments'));
  snap.forEach(d=>assessments.push({id:d.id, ...d.data()}));
}
async function loadClassNotices(){
  classNotices = {};
  const snap = await getDocs(collection(db,'classNotices'));
  snap.forEach(d=>{
    const c = d.data().className || 'unknown';
    (classNotices[c] ||= []).push({id:d.id, ...d.data()});
  });
}

// =============== UI ë Œë” ===============
function renderAll(){
  // header labels
  if(currentClass){
    $('#assess-title').textContent = `ğŸ“ ìˆ˜í–‰í‰ê°€ (í˜„ì¬: ${currentClass})`;
    $('#class-title').textContent = `ğŸ“£ ${currentClass} ë°˜ë³„ ê³µì§€`;
  }
  // events
  const evBox = $('#list-events'); evBox.innerHTML = '';
  events.slice().sort((a,b)=> (a.date||'').localeCompare(b.date)).reverse().forEach(n=>evBox.appendChild(makeCard(n,'event')));
  // assessments
  const asBox = $('#list-assessments'); asBox.innerHTML = '';
  assessments.slice().sort((a,b)=> (a.date||'').localeCompare(b.date)).reverse().forEach(n=>asBox.appendChild(makeAssessmentCard(n)));
  // class notices
  const clBox = $('#list-class'); clBox.innerHTML = '';
  const arr = currentClass ? (classNotices[currentClass]||[]) : [];
  arr.slice().sort((a,b)=> (a.date||'').localeCompare(b.date)).reverse().forEach(n=>clBox.appendChild(makeCard(n,'class')));
}

function filePreviewHTML(n){
  if(!n || !n.fileData) return '';
  if((n.fileType||'').startsWith('image/')){
    return `<div class="file-preview"><img data-preview="1" src="${n.fileData}" alt="${n.fileName||'ì´ë¯¸ì§€'}" /></div>`;
  }
  return `<a class="file-link" href="${n.fileData}" download="${n.fileName||'file'}">ğŸ“ ${n.fileName||'ì²¨ë¶€íŒŒì¼'}</a>`;
}

function makeCard(n, category){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="date">${n.date||''}</div>
    <div class="title">${n.title||''}</div>
    <div class="description">${n.description||''}</div>
    ${filePreviewHTML(n)}
  `;

  // image lightbox
  card.querySelectorAll('img[data-preview]')?.forEach(img=>{
    img.addEventListener('click',()=>openLightbox(img.src));
  });

  const actions = document.createElement('div');
  actions.className = 'actions';
  const bEdit = document.createElement('button'); bEdit.className='btn'; bEdit.textContent='ìˆ˜ì •';
  const bDel  = document.createElement('button'); bDel.className='btn danger'; bDel.textContent='ì‚­ì œ';
  actions.appendChild(bEdit); actions.appendChild(bDel); card.appendChild(actions);

  bEdit.addEventListener('click', ()=> openEditorForEdit(category, n));
  bDel.addEventListener('click', ()=> handleDelete(category, n));

  return card;
}

function makeAssessmentCard(n){
  const el = makeCard(n,'assessment');
  // session quick view (default vs class override)
  const wrap = document.createElement('div');
  wrap.className='help';
  const list = (n.defaultSessions||[]).slice().sort((a,b)=>(a.order||0)-(b.order||0)).map(x=>`${x.order}ì°¨ì‹œ: ${x.text}`).join(' \u00B7 ');
  wrap.textContent = list ? `ê¸°ë³¸ ì°¨ì‹œ: ${list}` : 'ê¸°ë³¸ ì°¨ì‹œ ì—†ìŒ';
  el.appendChild(wrap);

  // open per-class session editor
  const btn = document.createElement('button');
  btn.className = 'btn ghost';
  btn.textContent = 'ë°˜ë³„ ì°¨ì‹œ í¸ì§‘';
  btn.style.marginTop = '8px';
  btn.addEventListener('click', ()=> openSessionPanel(n));
  el.appendChild(btn);
  return el;
}

// =============== ë¼ì´íŠ¸ë°•ìŠ¤ ===============
function openLightbox(src){
  const lb = $('#lightbox');
  lb.querySelector('img').src = src;
  lb.classList.add('show');
}
$('#lightbox .btn').addEventListener('click', ()=> $('#lightbox').classList.remove('show'));
$('#lightbox').addEventListener('click', (e)=>{ if(e.target.id==='lightbox') $('#lightbox').classList.remove('show'); });

// =============== í¸ì§‘ê¸° ===============
function resetEditor(){
  $('#f-category').value='event';
  $('#f-date').value='';
  $('#f-title').value='';
  $('#f-desc').value='';
  $('#f-file').value='';
  $('#file-preview').innerHTML='';
  $('#session-list').innerHTML='';
  $('#session-editor').classList.add('hidden');
}

function openEditorForCreate(){
  editContext = {mode:'create', category:'event', col:null, id:null};
  $('#editor-title').textContent='ìƒˆ ê¸€ ì‘ì„±';
  resetEditor();
  $('#class-select').classList.add('hidden');
  $('#main').classList.add('hidden');
  $('#editor').classList.remove('hidden');
}

function openEditorForEdit(category, n){
  editContext = {mode:'edit', category, id:n.id};
  $('#editor-title').textContent='ê¸€ ìˆ˜ì •';
  resetEditor();
  $('#f-category').value = category==='class' ? 'class' : category; // lock by change
  $('#f-category').disabled = true;
  $('#f-date').value = n.date || '';
  $('#f-title').value = n.title || '';
  $('#f-desc').value = n.description || '';
  if(n.fileData){
    $('#file-preview').innerHTML = filePreviewHTML(n);
    $('#file-preview img')?.addEventListener('click',()=>openLightbox(n.fileData));
  }
  if(category==='assessment'){
    $('#session-editor').classList.remove('hidden');
    (n.defaultSessions||[]).forEach(x=> addSessionRow(x.order, x.text));
  }
  $('#class-select').classList.add('hidden');
  $('#main').classList.add('hidden');
  $('#editor').classList.remove('hidden');
}

function addSessionRow(order='', text=''){
  const row = document.createElement('div');
  row.className='session-item';
  row.innerHTML = `<input type="number" class="s-order" placeholder="ì°¨ì‹œ(ìˆ«ì)" value="${order}"> <input type="text" class="s-text" placeholder="ì˜ˆ) ë³´ê³ ì„œ ì•ˆë‚´" value="${text}"> <button class="btn danger" type="button">ì‚­ì œ</button>`;
  row.querySelector('button').addEventListener('click', ()=> row.remove());
  $('#session-list').appendChild(row);
}
$('#btn-add-session').addEventListener('click', ()=> addSessionRow());

$('#f-category').addEventListener('change', (e)=>{
  const v = e.target.value;
  if(v==='assessment') $('#session-editor').classList.remove('hidden');
  else $('#session-editor').classList.add('hidden');
});

// íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
$('#f-file').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) { $('#file-preview').innerHTML=''; return; }
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    if(file.type.startsWith('image/')){
      $('#file-preview').innerHTML = `<div class="file-preview"><img data-preview="1" src="${dataUrl}" alt="ë¯¸ë¦¬ë³´ê¸°"></div>`;
      $('#file-preview img').addEventListener('click',()=>openLightbox(dataUrl));
    } else {
      $('#file-preview').innerHTML = `<a class="file-link" href="${dataUrl}" download="${file.name}">ğŸ“ ${file.name}</a>`;
    }
  };
  reader.readAsDataURL(file);
});

// ì €ì¥ ë¡œì§
async function saveEditor(){
  const cat = $('#f-category').value; // event | assessment | class
  const date = $('#f-date').value?.trim();
  const title = $('#f-title').value?.trim();
  const description = $('#f-desc').value?.trim();
  const file = $('#f-file').files[0];
  if(!cat || !date || !title || !description) return alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');

  // ê¶Œí•œ ì²´í¬
  if(cat==='event'){
    // í–‰ì‚¬: ë§ˆìŠ¤í„° ë¹„ë²ˆ í•„ìš”
    if(!await requireMaster()) return;
  } else if(cat==='assessment'){
    // ìˆ˜í–‰í‰ê°€ ë³¸ë¬¸: ë§ˆìŠ¤í„° ë¹„ë²ˆ í•„ìš” (ì„¸ë¶€ ì°¨ì‹œëŠ” ë°˜ë³„ í¸ì§‘ í™”ë©´ì—ì„œ)
    if(!await requireMaster()) return;
  } else if(cat==='class'){
    // ë°˜ë³„ ê³µì§€: í˜„ì¬ ë°˜ + í•´ë‹¹ ë°˜ ë¹„ë²ˆ ë˜ëŠ” ë§ˆìŠ¤í„°
    if(!currentClass) return alert('ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.');
    const ok = await requireClassOrMaster(currentClass);
    if(!ok) return;
  }

  const base = { date, title, description, updatedAt: serverTimestamp() };
  if(file){
    base.fileName = file.name; base.fileType = file.type;
    base.fileData = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file); });
  }

  if(editContext?.mode==='edit'){
    // update existing
    if(cat==='event') await updateDoc(doc(db,'events', editContext.id), base);
    if(cat==='assessment'){
      // include defaultSessions from editor
      const sessions = collectSessionEditor();
      await updateDoc(doc(db,'assessments', editContext.id), {...base, defaultSessions: sessions});
    }
    if(cat==='class') await updateDoc(doc(db,'classNotices', editContext.id), {...base, className: currentClass});
  } else {
    // create new
    if(cat==='event') await addDoc(collection(db,'events'), {...base, createdAt: serverTimestamp()});
    if(cat==='assessment'){
      const sessions = collectSessionEditor();
      await addDoc(collection(db,'assessments'), {...base, createdAt: serverTimestamp(), defaultSessions: sessions});
    }
    if(cat==='class') await addDoc(collection(db,'classNotices'), {...base, className: currentClass, createdAt: serverTimestamp()});
  }

  await reloadAndReturn();
}

function collectSessionEditor(){
  const rows = [...$$('#session-list .session-item')];
  const items = rows.map(r=>({ order: Number(r.querySelector('.s-order').value||0), text: r.querySelector('.s-text').value.trim() }))
                    .filter(x=>x.text);
  // unique & sort
  const seen = new Set();
  const dedup = items.filter(x=>{ const k = x.order+':'+x.text; if(seen.has(k)) return false; seen.add(k); return true; })
                     .sort((a,b)=>(a.order||0)-(b.order||0));
  return dedup;
}

async function reloadAndReturn(){
  await Promise.all([loadEvents(), loadAssessments(), loadClassNotices()]);
  renderAll();
  $('#editor').classList.add('hidden');
  $('#main').classList.remove('hidden');
}

// ì‚­ì œ
async function handleDelete(category, n){
  if(category==='event' || category==='assessment'){
    if(!await requireMaster()) return; // ë§ˆìŠ¤í„°ë§Œ ì‚­ì œ
  } else if(category==='class'){
    const ok = await requireClassOrMaster(n.className);
    if(!ok) return;
  }
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  if(category==='event') await deleteDoc(doc(db,'events', n.id));
  if(category==='assessment') await deleteDoc(doc(db,'assessments', n.id));
  if(category==='class') await deleteDoc(doc(db,'classNotices', n.id));
  await loadAll();
}

// ====== ìˆ˜í–‰í‰ê°€ ì°¨ì‹œ (ë°˜ë³„ í¸ì§‘) ======
// ====== ìˆ˜í–‰í‰ê°€ ì°¨ì‹œ (ë°˜ë³„ í¸ì§‘) ======
function openSessionPanel(assessment){
  if(!currentClass) return alert('ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.');
  $('#sp-assessment-title').textContent = assessment.title;
  $('#session-panel').dataset.assessmentId = assessment.id;
  $('#session-panel').classList.remove('hidden');
  $('#main').classList.add('hidden');
  loadClassSessionsIntoPanel(assessment);
}

// âœ… ìˆ˜ì •ë¨: ë°˜ë³„ ì°¨ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ë‚ ì§œ/êµì‹œ ì „ìš©)
async function loadClassSessionsIntoPanel(assessment){
  const ref = doc(db,'assessments', assessment.id, 'sessions', currentClass);
  const sdoc = await getDoc(ref);
  const items = sdoc.exists() ? (sdoc.data().items||[]) : [];
  const box = $('#class-session-list');
  box.innerHTML='';
  items.forEach(x=>{
    const row = document.createElement('div');
    row.className='session-item';
    row.innerHTML = `
      <input type="date" class="s-date" value="${x.date||''}">
      <input type="text" class="s-period" value="${x.period||''}" placeholder="ì˜ˆ: 3êµì‹œ">
      <button class="btn danger" type="button">ì‚­ì œ</button>`;
    row.querySelector('button').addEventListener('click',()=> row.remove());
    box.appendChild(row);
  });
}

// âœ… ìˆ˜ì •ë¨: ìƒˆ í–‰ ì¶”ê°€ (ë‚ ì§œ/êµì‹œ)
$('#sp-add').addEventListener('click', ()=>{
  const row = document.createElement('div');
  row.className='session-item';
  row.innerHTML = `
    <input type="date" class="s-date">
    <input type="text" class="s-period" placeholder="ì˜ˆ: 4êµì‹œ">
    <button class="btn danger" type="button">ì‚­ì œ</button>`;
  row.querySelector('button').addEventListener('click',()=> row.remove());
  $('#class-session-list').appendChild(row);
});

// âœ… ìˆ˜ì •ë¨: ì €ì¥ ì‹œ ë‚ ì§œ/êµì‹œë§Œ ì €ì¥
$('#sp-save').addEventListener('click', async ()=>{
  if(!currentClass) return alert('ë°˜ ì„ íƒ í•„ìš”');
  const ok = await requireClassPasswordOnly(currentClass);
  if(!ok) return;

  const items = [...$$('#class-session-list .session-item')]
    .map(r=>({
      date: r.querySelector('.s-date').value.trim(),
      period: r.querySelector('.s-period').value.trim()
    }))
    .filter(x=>x.date && x.period);

  const aid = $('#session-panel').dataset.assessmentId;
  await setDoc(doc(db,'assessments', aid, 'sessions', currentClass), {
    items,
    updatedAt: serverTimestamp()
  });
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  $('#session-panel').classList.add('hidden');
  $('#main').classList.remove('hidden');
});
$('#sp-cancel').addEventListener('click', ()=>{
  $('#session-panel').classList.add('hidden');
  $('#main').classList.remove('hidden');
});


// =============== ê¶Œí•œ ì²´í¬ ===============
async function requireMaster(){
  if(!masterHash){ alert('ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return false; }
  const p = prompt('ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  if(p===null) return false;
  const ok = await verifyPassword(p, masterHash);
  if(!ok) alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  return ok;
}
async function requireClassPasswordOnly(className){
  const c = classes[className];
  if(!c || !c.passwordHash){ alert('í•´ë‹¹ ë°˜ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return false; }
  const p = prompt(`${className} ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”`);
  if(p===null) return false;
  const ok = await verifyPassword(p, c.passwordHash);
  if(!ok) alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  return ok;
}
async function requireClassOrMaster(className){
  const p = prompt(`${className} ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”`);
  if(p===null) return false;
  const h = await sha256Hex(p);
  const ok = (classes[className]?.passwordHash && h===classes[className].passwordHash) || (masterHash && h===masterHash);
  if(!ok) alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  return ok;
}

// =============== ë°˜ ì„ íƒ ===============
function selectClass(){
  const v = $('#class-select-input').value;
  if(!/^1í•™ë…„[1-9]ë°˜$/.test(v)) return alert('ë°˜ì„ ì„ íƒí•˜ì„¸ìš”');
  currentClass = v;
  $('#class-select').classList.add('hidden');
  $('#main').classList.remove('hidden');
  renderAll();
}
function backToClass(){
  currentClass = null;
  $('#main').classList.add('hidden');
  $('#class-select').classList.remove('hidden');
}

// =============== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===============
$('#class-confirm-btn').addEventListener('click', selectClass);
$('#nav-back').addEventListener('click', backToClass);
$('#btn-add').addEventListener('click', openEditorForCreate);
$('#btn-cancel').addEventListener('click', ()=>{ $('#editor').classList.add('hidden'); $('#main').classList.remove('hidden'); });
$('#btn-save').addEventListener('click', saveEditor);

// ìµœì´ˆ ë¡œë“œ
await loadAll();
</script>
</body>
</html>
