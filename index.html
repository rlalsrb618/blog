<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>중원고 공지 알리미 (단순 비밀번호 버전)</title>
<style>
body{font-family:'Segoe UI',system-ui,-apple-system,Malgun Gothic,sans-serif;background:#f8f9fb;margin:0;color:#333}
header{background:#1c3c78;color:#fff;text-align:center;padding:24px 12px}
.container{max-width:980px;margin:0 auto;padding:20px}
.btn{background:#1c3c78;color:#fff;border:0;border-radius:6px;padding:8px 14px;cursor:pointer}
.btn.danger{background:#c0392b}
.btn.muted{background:#888}
select,input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;font:inherit}
.card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px}
</style>
</head>
<body>
<header>
  <h1>중원고 공지 알리미</h1>
</header>
<section class="container">
  <div>
    <label>반 선택</label>
    <select id="class-select">
      <option value="" selected disabled>반 선택</option>
      <option>1학년1반</option>
      <option>1학년2반</option>
      <option>1학년3반</option>
      <option>1학년4반</option>
      <option>1학년5반</option>
      <option>1학년6반</option>
      <option>1학년7반</option>
      <option>1학년8반</option>
      <option>1학년9반</option>
    </select>
  </div>
  <button id="btn-enter" class="btn">확인</button>
</section>
<section class="container hidden" id="main">
  <div style="display:flex;gap:10px;margin-bottom:12px">
    <button id="btn-back" class="btn muted">← 반 다시 선택</button>
    <button id="btn-add" class="btn">+ 글 추가</button>
  </div>
  <h2>📅 행사 (공통)</h2>
  <div id="events"></div>
  <h2>📝 수행평가</h2>
  <div id="assessments"></div>
  <h2 id="class-title">📣 반별 공지</h2>
  <div id="classNotices"></div>
</section>
<section class="container hidden" id="editor">
  <h2 id="editor-title">글 작성</h2>
  <label>카테고리</label>
  <select id="category">
    <option value="event">행사</option>
    <option value="assessment">수행평가</option>
    <option value="class">반별 공지</option>
  </select>
  <label>제목</label><input id="title" type="text">
  <label>날짜</label><input id="date" type="date">
  <label>내용</label><textarea id="desc"></textarea>
  <label>이미지</label><input id="file" type="file" accept="image/*">
  <div style="margin-top:10px">
    <button id="btn-save" class="btn">저장</button>
    <button id="btn-cancel" class="btn muted">취소</button>
  </div>
</section>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyAxyzwEpyLDxBjS9Wn2wjgzrphx4surn5g",
  authDomain: "jungwonjd2.firebaseapp.com",
  projectId: "jungwonjd2",
  storageBucket: "jungwonjd2.firebasestorage.app",
  messagingSenderId: "197915083889",
  appId: "1:197915083889:web:5c85a163afcf7311eb07d0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentClass=null;
let masterPassword="0922";
let classPasswords={"1학년1반":"1111","1학년2반":"2222"}; // 예시
const $=s=>document.querySelector(s);

$('#btn-enter').onclick=()=>{
  const v=$('#class-select').value;
  if(!v) return alert('반을 선택하세요');
  currentClass=v;
  $('#main').classList.remove('hidden');
  $('#class-title').textContent=`📣 ${v} 반별 공지`;
  loadAll();
  document.querySelector('section.container').classList.add('hidden');
};
$('#btn-back').onclick=()=>location.reload();
$('#btn-add').onclick=()=>{
  $('#editor').classList.remove('hidden');
  $('#main').classList.add('hidden');
};
$('#btn-cancel').onclick=()=>{
  $('#editor').classList.add('hidden');
  $('#main').classList.remove('hidden');
};

async function loadAll(){
  const ev=await getDocs(collection(db,'events'));
  const evBox=$('#events');evBox.innerHTML='';
  ev.forEach(d=>evBox.innerHTML+=cardHTML(d.data(),'event'));
  const as=await getDocs(collection(db,'assessments'));
  const asBox=$('#assessments');asBox.innerHTML='';
  as.forEach(d=>asBox.innerHTML+=cardHTML(d.data(),'assessment'));
  const cl=await getDocs(collection(db,'classNotices'));
  const clBox=$('#classNotices');clBox.innerHTML='';
  cl.forEach(d=>{if(d.data().className===currentClass)clBox.innerHTML+=cardHTML(d.data(),'class')});
}
function cardHTML(n,type){
  return `<div class='card'><b>${n.title||'(제목없음)'}</b><br>${n.date||''}<p>${n.description||''}</p>${n.image?`<img src='${n.image}' style='max-width:200px'>`:''}</div>`;
}

$('#btn-save').onclick=async()=>{
  const category=$('#category').value;
  const title=$('#title').value.trim();
  const desc=$('#desc').value.trim();
  const date=$('#date').value;
  const file=$('#file').files[0];
  if(!title||!desc||!date) return alert('빈칸을 채우세요');
  let pass=prompt('비밀번호 입력 (마스터 또는 반 비번)');
  if(!pass) return;
  if(category==='event'||category==='assessment'){
    if(pass!==masterPassword) return alert('마스터 비밀번호가 틀림');
  }
  if(category==='class'){
    const clsOk=classPasswords[currentClass]===pass||pass===masterPassword;
    if(!clsOk) return alert('비밀번호 틀림');
  }
  let imageData='';
  if(file){
    const r=new FileReader();
    imageData=await new Promise(res=>{r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
  }
  const base={title,description:desc,date,image:imageData,className:currentClass,createdAt:serverTimestamp()};
  if(category==='event') await addDoc(collection(db,'events'),base);
  if(category==='assessment') await addDoc(collection(db,'assessments'),base);
  if(category==='class') await addDoc(collection(db,'classNotices'),base);
  alert('저장됨');
  location.reload();
};
</script>
</body>
</html>
