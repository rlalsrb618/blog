<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¤‘ì›ê³  ì•Œë¦¬ë¯¸ ê°œí¸</title>
  <style>
    body {font-family: Pretendard, sans-serif; margin: 30px;}
    .hidden {display: none;}
    .btn {padding: 6px 10px; border: none; border-radius: 6px; background: #2563eb; color: white; cursor: pointer;}
    .btn.danger {background: #dc2626;}
    .btn.muted {background: #6b7280;}
    .btn.ghost {background: transparent; border: 1px solid #9ca3af; color: #374151;}
    .stack-sm {margin-bottom: 10px;}
    .grid.two {display: grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    .section-head {display: flex; justify-content: space-between; align-items: center;}
    .file-preview img {max-width: 200px; margin-top: 5px; cursor: pointer;}
    .session-item {display: flex; gap: 6px; margin: 4px 0;}
  </style>
</head>

<body>
  <section id="main" class="container">
    <div class="grid two">
      <div>
        <div class="section-head"><h2>ğŸ“… í–‰ì‚¬ (ì „ì²´ê³µí†µ)</h2></div>
        <div id="list-events"></div>
      </div>
      <div>
        <div class="section-head"><h2 id="assess-title">ğŸ“ ìˆ˜í–‰í‰ê°€</h2></div>
        <div id="list-assessments"></div>
      </div>
    </div>
    <h2 id="class-title">ğŸ“£ ë°˜ë³„ ê³µì§€</h2>
    <div id="list-class"></div>
  </section>

  <!-- ì‘ì„±/ìˆ˜ì • í¼ -->
  <section id="editor" class="container hidden">
    <h2 id="editor-title">ìƒˆ ê¸€</h2>
    <div class="grid two">
      <div class="stack-sm">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="f-category">
          <option value="event">í–‰ì‚¬ (ì „ì²´ê³µí†µ)</option>
          <option value="assessment">ìˆ˜í–‰í‰ê°€ (ë‚´ìš© ê³µí†µ)</option>
          <option value="class">ë°˜ë³„ ê³µì§€</option>
        </select>
      </div>
      <div class="stack-sm">
        <label>ë‚ ì§œ</label>
        <input id="f-date" type="date" />
      </div>
    </div>

    <div class="grid two">
      <div class="stack-sm"><label>ì œëª©</label><input id="f-title" type="text" placeholder="ì œëª©" /></div>
      <div class="stack-sm"><label>ì²¨ë¶€íŒŒì¼</label><input id="f-file" type="file" accept="image/*,.pdf" /></div>
    </div>

    <div class="stack-sm">
      <label>ë‚´ìš©</label>
      <textarea id="f-desc" placeholder="ë‚´ìš©"></textarea>
      <div id="file-preview" class="file-preview"></div>
    </div>

    <!-- ìˆ˜í–‰í‰ê°€ ê³µí†µ ì°¨ì‹œ ì…ë ¥ -->
    <div id="session-editor" class="hidden" style="margin-top:18px">
      <div class="section-head"><h3>ê³µí†µ ì°¨ì‹œ ì •ë³´ (+/-ë¡œ ì¶”ê°€)</h3><span class="help">ì˜ˆì‹œ: 1ì°¨ì‹œ : ë³´ê³ ì„œ ì•ˆë‚´</span></div>
      <div id="session-list"></div>
      <div class="toolbar"><button id="btn-add-session" class="btn ghost">+ ì°¨ì‹œ ì¶”ê°€</button></div>
    </div>

    <div class="toolbar">
      <button id="btn-save" class="btn">ì €ì¥</button>
      <button id="btn-cancel" class="btn muted">ì·¨ì†Œ</button>
    </div>
  </section>

  <!-- ë°˜ë³„ ì°¨ì‹œ í¸ì§‘ -->
  <section id="session-panel" class="container hidden">
    <div class="section-head"><h2>ì°¨ì‹œ í¸ì§‘ (ë°˜ë³„ ë¹„ë°€ë²ˆí˜¸ í•„ìš”)</h2><span class="badge" id="sp-assessment-title">-</span></div>
    <div id="class-session-list"></div>
    <div class="toolbar">
      <button id="sp-add" class="btn ghost">+ ì°¨ì‹œ ì¶”ê°€</button>
      <button id="sp-save" class="btn">ì €ì¥</button>
      <button id="sp-cancel" class="btn muted">ë‹«ê¸°</button>
    </div>
  </section>

  <div id="lightbox" class="lightbox hidden"><button class="btn">ë‹«ê¸°</button><img alt="preview" /></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxyzwEpyLDxBjS9Wn2wjgzrphx4surn5g",
      authDomain: "jungwonjd2.firebaseapp.com",
      projectId: "jungwonjd2",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- ê¸°ë³¸ ìœ í‹¸ ---
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    let currentClass = null;
    let editContext = null;

    // ì„¸ì…˜(ê³µí†µ)
    function addSessionRow(order='', text=''){
      const row = document.createElement('div');
      row.className='session-item';
      row.innerHTML = `
        <input type="number" class="s-order" placeholder="ì°¨ì‹œ(ìˆ«ì)" value="${order}">
        <input type="text" class="s-text" placeholder="í™œë™ ë‚´ìš©" value="${text}">
        <button class="btn danger" type="button">ì‚­ì œ</button>`;
      row.querySelector('button').addEventListener('click', ()=> row.remove());
      $('#session-list').appendChild(row);
    }
    $('#btn-add-session').addEventListener('click', ()=> addSessionRow());

    $('#f-category').addEventListener('change', e=>{
      const v=e.target.value;
      if(v==='assessment') $('#session-editor').classList.remove('hidden');
      else $('#session-editor').classList.add('hidden');
    });

    // --- ì €ì¥ ë¡œì§ ---
    async function saveEditor(){
      const cat = $('#f-category').value;
      const date = $('#f-date').value?.trim();
      const title = $('#f-title').value?.trim();
      const description = $('#f-desc').value?.trim();
      if(!cat||!date||!title||!description) return alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');

      const base = { date, title, description, updatedAt: serverTimestamp() };
      if(cat==='assessment'){
        const sessions = collectSessionEditor();
        await addDoc(collection(db,'assessments'), {...base, createdAt: serverTimestamp(), defaultSessions: sessions});
      }
    }

    function collectSessionEditor(){
      const rows = [...$$('#session-list .session-item')];
      return rows.map(r=>({
        order: Number(r.querySelector('.s-order').value||0),
        text: r.querySelector('.s-text').value.trim()
      })).filter(x=>x.text);
    }

    // ===============================
    // ğŸ”§ ìˆ˜ì •ëœ ë°˜ë³„ ì°¨ì‹œ ë¶€ë¶„ (ë‚ ì§œ/êµì‹œ)
    // ===============================
    async function loadClassSessionsIntoPanel(assessment){
      const ref = doc(db,'assessments', assessment.id, 'sessions', currentClass);
      const sdoc = await getDoc(ref);
      const items = sdoc.exists() ? (sdoc.data().items||[]) : [];
      const box = $('#class-session-list');
      box.innerHTML = '';
      items.forEach(x=>{
        const row = document.createElement('div');
        row.className='session-item';
        row.innerHTML = `
          <input type="date" class="s-date" value="${x.date||''}">
          <input type="text" class="s-period" value="${x.period||''}" placeholder="ì˜ˆ: 3êµì‹œ">
          <button class="btn danger" type="button">ì‚­ì œ</button>`;
        row.querySelector('button').addEventListener('click', ()=> row.remove());
        box.appendChild(row);
      });
    }

    $('#sp-add').addEventListener('click', ()=>{
      const row = document.createElement('div');
      row.className='session-item';
      row.innerHTML = `
        <input type="date" class="s-date">
        <input type="text" class="s-period" placeholder="ì˜ˆ: 4êµì‹œ">
        <button class="btn danger" type="button">ì‚­ì œ</button>`;
      row.querySelector('button').addEventListener('click', ()=> row.remove());
      $('#class-session-list').appendChild(row);
    });

    $('#sp-save').addEventListener('click', async ()=>{
      if(!currentClass) return alert('ë°˜ ì„ íƒ í•„ìš”');
      const ok = await requireClassPasswordOnly(currentClass); // ì´ë¯¸ êµ¬í˜„ëœ í•¨ìˆ˜
      if(!ok) return;

      const items = [...$$('#class-session-list .session-item')]
        .map(r=>({
          date: r.querySelector('.s-date').value.trim(),
          period: r.querySelector('.s-period').value.trim()
        }))
        .filter(x=>x.date && x.period);

      const aid = $('#session-panel').dataset.assessmentId;
      await setDoc(doc(db,'assessments', aid, 'sessions', currentClass),
        {items, updatedAt: serverTimestamp()});
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      $('#session-panel').classList.add('hidden');
      $('#main').classList.remove('hidden');
    });
  </script>
</body>
</html>
