<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¤‘ì›ê³  ê³µì§€ ì•Œë¦¬ë¯¸ (Firebase)</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f5f8fc; margin:0; padding:20px; color:#333; }
    header { text-align:center; padding:20px 0; background:#1c3c78; color:#fff; }
    .container { max-width:900px; margin:0 auto; }
    h2 { border-bottom:2px solid #1c3c78; padding-bottom:5px; margin-top:40px; }
    .card { background:#fff; padding:15px 20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; position:relative; }
    .date { font-weight:bold; color:#1c3c78; }
    .title { font-size:18px; margin:5px 0; }
    .description { font-size:14px; color:#555; white-space:pre-wrap; }
    .edit-btn, .delete-btn { position:absolute; top:15px; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; color:white; }
    .edit-btn { right:70px; background:#1c3c78; } 
    .delete-btn { right:15px; background:#c0392b; }
    .edit-btn:hover{background:#163063} 
    .delete-btn:hover{background:#962d22}
    textarea,input{width:100%; box-sizing:border-box; margin-top:4px; font-family:inherit}
    .hidden{display:none}
    .add-btn{display:block; margin:20px auto; padding:10px 20px; background:#1c3c78; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer}
    .add-btn:hover{background:#163063}
    .back-btn{margin:15px 0; padding:8px 16px; background:#888; color:#fff; border:none; border-radius:6px; cursor:pointer}
    .back-btn:hover{background:#555}
    .file-preview{margin-top:10px} 
    .file-preview img{max-width:200px;border-radius:6px;margin-top:5px;display:block}
    .file-link{display:inline-block;margin-top:5px;color:#1c3c78;text-decoration:underline}
    #debug { font-size:13px; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <header>
    <h1>ì¤‘ì›ê³  í–‰ì‚¬Â·ìˆ˜í–‰í‰ê°€ ì•Œë¦¬ë¯¸</h1>
    <p>ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”</p>
  </header>

  <div id="class-select" class="container">
    <h2>ìì‹ ì˜ ë°˜ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
    <p>ğŸ‘‰ ë„ì–´ì“°ê¸° ì—†ì´ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1í•™ë…„7ë°˜)</p>
    <input type="text" id="class-input" placeholder="ì˜ˆ: 1í•™ë…„7ë°˜">
    <button id="class-confirm-btn" class="add-btn" type="button">í™•ì¸</button>
    <div id="debug">ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
  </div>

  <div id="main-container" class="container hidden">
    <button id="back-btn" class="back-btn">â† ì´ì „ìœ¼ë¡œ</button>
    <button id="add-general-btn" class="add-btn">+ ê³µì§€ ì¶”ê°€í•˜ê¸°</button>
    <h2>ğŸ“… ì˜¤ëŠ˜ì˜ í–‰ì‚¬</h2>
    <div id="notice-list"></div>

    <h2 id="class-title">ğŸ“ ìˆ˜í–‰í‰ê°€</h2>
    <button id="add-class-btn" class="add-btn">+ ìˆ˜í–‰í‰ê°€ ì¶”ê°€í•˜ê¸°</button>
    <div id="class-notice-list"></div>
  </div>

  <div id="add-form" class="container hidden">
    <h2>ğŸ“Œ ìƒˆ ê³µì§€ ì¶”ê°€</h2>
    <input type="text" id="add-date" placeholder="ë‚ ì§œ (ì˜ˆ: 2025-10-21)">
    <input type="text" id="add-title" placeholder="ì œëª©">
    <textarea id="add-desc" placeholder="ë‚´ìš©"></textarea>
    <input type="file" id="add-file" accept=".pdf,image/*">
    <br><br>
    <button id="submit-add-btn" class="add-btn">ë“±ë¡</button>
    <button id="cancel-add-btn" class="back-btn">ì·¨ì†Œ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ==== Firebase ì„¤ì • ====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const PASSWORD = "0922";
    let currentClass = null;
    let addingType = null;
    let generalNotices = [];
    let classNotices = {};

    const debugEl = txt => document.getElementById('debug').innerText = txt;

    async function loadNotices() {
      try {
        generalNotices = [];
        classNotices = {};

        const genSnap = await getDocs(collection(db, 'generalNotices'));
        genSnap.forEach(d => generalNotices.push({ id:d.id, ...d.data() }));

        const clsSnap = await getDocs(collection(db, 'classNotices'));
        clsSnap.forEach(d => {
          const cname = d.data().className || 'unknown';
          if(!classNotices[cname]) classNotices[cname] = [];
          classNotices[cname].push({ id:d.id, ...d.data() });
        });

        renderNotices();
        debugEl(`ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ`);
      } catch(e) {
        console.error(e);
        debugEl('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      }
    }

    function renderNotices() {
      const noticeList = document.getElementById('notice-list');
      noticeList.innerHTML = '';
      generalNotices.slice().reverse().forEach(n => noticeList.appendChild(makeCard(n,'general')));

      const classList = document.getElementById('class-notice-list');
      classList.innerHTML = '';
      const arr = (currentClass && classNotices[currentClass]) ? classNotices[currentClass] : [];
      arr.slice().reverse().forEach(n => classList.appendChild(makeCard(n,'class')));
    }

    function makeCard(notice,type) {
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div class="date">${notice.date||''}</div>
                        <div class="title">${notice.title||''}</div>
                        <div class="description">${notice.description||''}</div>`;
      if(notice.fileData){
        const fp=document.createElement('div'); fp.className='file-preview';
        if(notice.fileType.startsWith('image/')) fp.innerHTML=`<img src="${notice.fileData}" alt="${notice.fileName||'ì´ë¯¸ì§€'}">`;
        else fp.innerHTML=`<a href="${notice.fileData}" download="${notice.fileName||'file'}" class="file-link">ğŸ“ ${notice.fileName||'ì²¨ë¶€íŒŒì¼'}</a>`;
        card.appendChild(fp);
      }

      const editBtn=document.createElement('button'); editBtn.className='edit-btn'; editBtn.type='button'; editBtn.innerText='ìˆ˜ì •';
      editBtn.onclick=()=>handleEdit(notice.id,type);
      const delBtn=document.createElement('button'); delBtn.className='delete-btn'; delBtn.type='button'; delBtn.innerText='ì‚­ì œ';
      delBtn.onclick=()=>handleDelete(notice.id,type);
      card.appendChild(editBtn); card.appendChild(delBtn);
      return card;
    }

    async function handleDelete(docId,type){
      try{
        const pw=prompt('ì‚­ì œ ë¹„ë°€ë²ˆí˜¸:');
        if(pw!==PASSWORD){alert('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');return;}
        if(!confirm('ì •ë§ ì‚­ì œ?')) return;
        const col = type==='general'?'generalNotices':'classNotices';
        await deleteDoc(doc(db,col,docId));
        await loadNotices();
      }catch(e){console.error(e); alert('ì‚­ì œ ì˜¤ë¥˜')}
    }

    async function handleEdit(docId,type){
      try{
        const pw=prompt('ìˆ˜ì • ë¹„ë°€ë²ˆí˜¸:');
        if(pw!==PASSWORD){alert('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');return;}
        const sourceArr = type==='general'?generalNotices:(classNotices[currentClass]||[]);
        const docObj = sourceArr.find(x=>x.id===docId);
        if(!docObj){alert('ê³µì§€ ì—†ìŒ'); return;}
        const newDate=prompt('ë‚ ì§œ',docObj.date||'');
        const newTitle=prompt('ì œëª©',docObj.title||'');
        const newDesc=prompt('ë‚´ìš©',docObj.description||'');
        const updates={};
        if(newDate!==null) updates.date=newDate;
        if(newTitle!==null) updates.title=newTitle;
        if(newDesc!==null) updates.description=newDesc;
        const col=type==='general'?'generalNotices':'classNotices';
        await updateDoc(doc(db,col,docId),updates);
        await loadNotices();
      }catch(e){console.error(e); alert('ìˆ˜ì • ì˜¤ë¥˜')}
    }

    function normalizeClassInput(raw){ return String(raw).replace(/\s+/g,'').replace(/\u3000/g,''); }

    function setClass(){
      const raw=document.getElementById('class-input').value;
      const input=normalizeClassInput(raw);
      const m=input
