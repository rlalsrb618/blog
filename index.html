<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¤‘ì›ê³  ê³µì§€ ì•Œë¦¬ë¯¸</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f8fc; margin: 0; padding: 20px; color:#333; }
    header { text-align:center; padding:20px 0; background:#1c3c78; color:#fff }
    .container { max-width:900px; margin:0 auto; }
    h2 { border-bottom:2px solid #1c3c78; padding-bottom:5px; margin-top:40px; }
    .card { background:#fff; padding:15px 20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; position:relative; }
    .date { font-weight:bold; color:#1c3c78; }
    .title { font-size:18px; margin:5px 0; }
    .description { font-size:14px; color:#555; white-space:pre-wrap; }
    .edit-btn, .delete-btn { position:absolute; top:15px; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; color:white; }
    .edit-btn { right:70px; background:#1c3c78; } .delete-btn { right:15px; background:#c0392b; }
    .edit-btn:hover{background:#163063} .delete-btn:hover{background:#962d22}
    textarea,input{width:100%; box-sizing:border-box; margin-top:4px; font-family:inherit}
    .hidden{display:none}
    .add-btn{display:block; margin:20px auto; padding:10px 20px; background:#1c3c78; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer}
    .add-btn:hover{background:#163063}
    .back-btn{margin:15px 0; padding:8px 16px; background:#888; color:#fff; border:none; border-radius:6px; cursor:pointer}
    .back-btn:hover{background:#555}
    .file-preview{margin-top:10px} .file-preview img{max-width:200px;border-radius:6px;margin-top:5px;display:block}
    .file-link{display:inline-block;margin-top:5px;color:#1c3c78;text-decoration:underline}
    #debug { font-size:13px; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <header>
    <h1>ì¤‘ì›ê³  í–‰ì‚¬Â·ìˆ˜í–‰í‰ê°€ ì•Œë¦¬ë¯¸</h1>
    <p>ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”</p>
  </header>

  <!-- ë°˜ ì„ íƒ í™”ë©´ -->
  <div id="class-select" class="class-select container">
    <h2>ìì‹ ì˜ ë°˜ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
    <p>ğŸ‘‰ ë„ì–´ì“°ê¸° ì—†ì´ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1í•™ë…„7ë°˜)</p>
    <input type="text" id="class-input" placeholder="ì˜ˆ: 1í•™ë…„7ë°˜">
    <button id="class-confirm-btn" class="add-btn" type="button">í™•ì¸</button>
    <div id="debug">ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
  </div>

  <!-- ì‹¤ì œ ê³µì§€ í™”ë©´ -->
  <div id="main-container" class="container hidden">
    <button id="back-btn" class="back-btn" type="button">â† ì´ì „ìœ¼ë¡œ</button>

    <button id="add-general-btn" class="add-btn" type="button">+ ê³µì§€ ì¶”ê°€í•˜ê¸°</button>
    <h2>ğŸ“… ì˜¤ëŠ˜ì˜ í–‰ì‚¬</h2>
    <div id="notice-list"></div>

    <h2 id="class-title">ğŸ“ ìˆ˜í–‰í‰ê°€</h2>
    <button id="add-class-btn" class="add-btn" type="button">+ ìˆ˜í–‰í‰ê°€ ì¶”ê°€í•˜ê¸°</button>
    <div id="class-notice-list"></div>
  </div>

  <!-- ê³µì§€ ì¶”ê°€ í¼ -->
  <div id="add-form" class="container hidden">
    <h2>ğŸ“Œ ìƒˆ ê³µì§€ ì¶”ê°€</h2>
    <input type="text" id="add-date" placeholder="ë‚ ì§œ (ì˜ˆ: 2025-07-25)">
    <input type="text" id="add-title" placeholder="ì œëª©">
    <textarea id="add-desc" placeholder="ë‚´ìš©"></textarea>
    <input type="file" id="add-file" accept=".pdf,image/*">
    <br><br>
    <button id="submit-add-btn" class="add-btn" type="button">ë“±ë¡</button>
    <button id="cancel-add-btn" class="back-btn" type="button">ì·¨ì†Œ</button>
  </div>

  <script type="module">
    // Firebase ëª¨ë“ˆ ë¡œë“œ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ==== ì—¬ê¸°ì— Firebase ì„¤ì • ë„£ìœ¼ì„¸ìš” ====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // ======================================

    const debugEl = txt => { const el = document.getElementById('debug'); if (el) el.innerText = txt; };

    // ì´ˆê¸°í™”
    let app;
    try {
      app = initializeApp(firebaseConfig);
      debugEl('Firebase ì´ˆê¸°í™” ì„±ê³µ (ì„¤ì • í™•ì¸ í•„ìš”)');
      console.log('Firebase initialized');
    } catch (err) {
      console.error('Firebase initialization error:', err);
      alert('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ â€” ì½˜ì†” í™•ì¸');
      debugEl('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ â€” ì½˜ì†” í™•ì¸');
      throw err;
    }

    const db = getFirestore(app);

    const PASSWORD = "0922";
    let currentClass = null;
    let addingType = null;

    let generalNotices = []; // [{id, date, title, description, ...}]
    let classNotices = {};   // { "1í•™ë…„7ë°˜": [{id, ...}, ...] }

    // Firestoreì—ì„œ ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadNotices() {
      debugEl('ê³µì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      try {
        generalNotices = [];
        classNotices = {};

        const genSnap = await getDocs(collection(db, 'generalNotices'));
        genSnap.forEach(d => generalNotices.push({ id: d.id, ...d.data() }));

        const clsSnap = await getDocs(collection(db, 'classNotices'));
        clsSnap.forEach(d => {
          const data = d.data();
          const cname = data.className || 'unknown';
          if (!classNotices[cname]) classNotices[cname] = [];
          classNotices[cname].push({ id: d.id, ...data });
        });

        debugEl(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ â€” ì „ì²´ ê³µì§€: ${generalNotices.length}, ë°˜ë³„ ê·¸ë£¹: ${Object.keys(classNotices).length}`);
        renderNotices();
      } catch (err) {
        console.error('loadNotices error:', err);
        debugEl('ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ â€” ì½˜ì†” í™•ì¸');
        alert('ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
      }
    }

    // ë Œë”
    function renderNotices() {
      const noticeList = document.getElementById('notice-list');
      noticeList.innerHTML = '';
      // ìµœì‹  ìˆœìœ¼ë¡œ ë³´ì´ê²Œ Firestoreì—ì„œ ê°€ì ¸ì˜¨ ìˆœì„œë¥¼ ë°˜ëŒ€ë¡œ ì¶œë ¥ (ì›í•˜ë©´ sort ì¶”ê°€)
      generalNotices.slice().reverse().forEach(n => {
        noticeList.appendChild(makeCard(n, 'general'));
      });

      const classList = document.getElementById('class-notice-list');
      classList.innerHTML = '';
      const arr = (currentClass && classNotices[currentClass]) ? classNotices[currentClass] : [];
      arr.slice().reverse().forEach(n => {
        classList.appendChild(makeCard(n, 'class'));
      });
    }

    // ì¹´ë“œ ìƒì„± â€” id ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •/ì‚­ì œ ì‘ë™
    function makeCard(notice, type) {
      const card = document.createElement('div');
      card.className = 'card';

      const date = document.createElement('div');
      date.className = 'date';
      date.innerText = notice.date || '';

      const title = document.createElement('div');
      title.className = 'title';
      title.innerText = notice.title || '';

      const desc = document.createElement('div');
      desc.className = 'description';
      desc.innerText = notice.description || '';

      card.appendChild(date);
      card.appendChild(title);
      card.appendChild(desc);

      if (notice.fileData) {
        const fp = document.createElement('div');
        fp.className = 'file-preview';
        if (notice.fileType && notice.fileType.startsWith('image/')) {
          fp.innerHTML = `<img src="${notice.fileData}" alt="${notice.fileName || 'ì´ë¯¸ì§€'}">`;
        } else {
          fp.innerHTML = `<a href="${notice.fileData}" download="${notice.fileName || 'file'}" class="file-link">ğŸ“ ${notice.fileName || 'ì²¨ë¶€íŒŒì¼'}</a>`;
        }
        card.appendChild(fp);
      }

      // ìˆ˜ì • ë²„íŠ¼
      const editBtn = document.createElement('button');
      editBtn.className = 'edit-btn';
      editBtn.type = 'button';
      editBtn.innerText = 'ìˆ˜ì •';
      editBtn.onclick = () => handleEdit(notice.id, type);

      // ì‚­ì œ ë²„íŠ¼
      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn';
      delBtn.type = 'button';
      delBtn.innerText = 'ì‚­ì œ';
      delBtn.onclick = () => handleDelete(notice.id, type);

      card.appendChild(editBtn);
      card.appendChild(delBtn);

      return card;
    }

    // ì‚­ì œ: id ê¸°ë°˜
    async function handleDelete(docId, type) {
      try {
        const pw = prompt('ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (pw !== PASSWORD) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const col = (type === 'general') ? 'generalNotices' : 'classNotices';
        await deleteDoc(doc(db, col, docId));
        alert('ì‚­ì œ ì™„ë£Œ');
        await loadNotices();
      } catch (err) {
        console.error('handleDelete error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” í™•ì¸');
      }
    }

    // ìˆ˜ì •: ê°„ë‹¨ íŒì—… ìˆ˜ì • (id ê¸°ë°˜)
    async function handleEdit(docId, type) {
      try {
        const pw = prompt('ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (pw !== PASSWORD) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }

        // ë¬¸ì„œ í˜„ì¬ê°’ ê°€ì ¸ì˜¤ê¸° (from arrays)
        const sourceArr = (type === 'general') ? generalNotices : (classNotices[currentClass] || []);
        const docObj = sourceArr.find(x => x.id === docId);
        if (!docObj) { alert('í•´ë‹¹ ê³µì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

        const newDate = prompt('ë‚ ì§œ ìˆ˜ì •', docObj.date || '');
        const newTitle = prompt('ì œëª© ìˆ˜ì •', docObj.title || '');
        const newDesc = prompt('ë‚´ìš© ìˆ˜ì •', docObj.description || '');
        if (newDate === null && newTitle === null && newDesc === null) return; // ì·¨ì†Œ

        const updates = {};
        if (newDate !== null) updates.date = newDate;
        if (newTitle !== null) updates.title = newTitle;
        if (newDesc !== null) updates.description = newDesc;

        const col = (type === 'general') ? 'generalNotices' : 'classNotices';
        await updateDoc(doc(db, col, docId), updates);
        alert('ìˆ˜ì • ì™„ë£Œ');
        await loadNotices();
      } catch (err) {
        console.error('handleEdit error:', err);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” í™•ì¸');
      }
    }

    // ë°˜ ì„¤ì •
    function normalizeClassInput(raw) {
      if (!raw) return '';
      return String(raw).replace(/\s+/g, '').replace(/\u3000/g, '');
    }

    function setClass() {
      const raw = document.getElementById('class-input').value;
      const input = normalizeClassInput(raw);
      const m = input.match(/^1í•™ë…„([1-9])ë°˜$/);
      if (!m) { alert('ì…ë ¥ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: 1í•™ë…„7ë°˜ (1~9ë°˜)'); return; }
      currentClass = `1í•™ë…„${m[1]}ë°˜`;
      document.getElementById('class-select').classList.add('hidden');
      document.getElementById('main-container').classList.remove('hidden');
      document.getElementById('class-title').textContent = `ğŸ“ ${currentClass} ìˆ˜í–‰í‰ê°€`;
      debugEl(`í˜„ì¬ ë°˜: ${currentClass}`);
      // ì´ë¯¸ loadNoticesë¡œ ë°ì´í„°ëŠ” ë°›ì•„ë‘ì—ˆìœ¼ë‹ˆ ë Œë”
      renderNotices();
    }

    function goBack() {
      currentClass = null;
      document.getElementById('main-container').classList.add('hidden');
      document.getElementById('class-select').classList.remove('hidden');
    }

    // ì—´ê¸°/ì·¨ì†Œ
    function openAddForm(type) {
      const pw = prompt('ê³µì§€ ì¶”ê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw !== PASSWORD) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }
      if (type === 'class' && !currentClass) { alert('ë°˜ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
      addingType = type;
      document.getElementById('main-container').classList.add('hidden');
      document.getElementById('add-form').classList.remove('hidden');
    }

    function cancelAdd() {
      document.getElementById('add-form').classList.add('hidden');
      document.getElementById('main-container').classList.remove('hidden');
      addingType = null;
    }

    // FileReaderë¥¼ Promiseë¡œ ë˜í•‘
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    // ë“±ë¡ í•¨ìˆ˜: event.preventDefaultë¡œ ìƒˆë¡œê³ ì¹¨ ì°¨ë‹¨, íŒŒì¼ ì²˜ë¦¬ ì•ˆì „íˆ ì™„ë£Œ í›„ addDoc
    async function submitNotice(event) {
      try {
        if (event && typeof event.preventDefault === 'function') event.preventDefault();

        const date = document.getElementById('add-date').value.trim();
        const title = document.getElementById('add-title').value.trim();
        const description = document.getElementById('add-desc').value.trim();
        const fileInput = document.getElementById('add-file');
        const file = fileInput.files[0];

        if (!date || !title || !description) { alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        if (!addingType) { alert('ì¶”ê°€ ìœ í˜•ì´ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

        const notice = { date, title, description, createdAt: serverTimestamp() };

        if (file) {
          debugEl('íŒŒì¼ ì½ëŠ” ì¤‘...');
          notice.fileName = file.name;
          notice.fileType = file.type;
          notice.fileData = await readFileAsDataURL(file); // awaitë¡œ ì•ˆì „ ë³´ì¥
          debugEl('íŒŒì¼ ì½ê¸° ì™„ë£Œ');
        }

        const col = (addingType === 'general') ? 'generalNotices' : 'classNotices';
        const payload = (addingType === 'class') ? { className: currentClass, ...notice } : notice;

        await addDoc(collection(db, col), payload);
        alert('ë“±ë¡ ì™„ë£Œ!');
        debugEl('ë“±ë¡ ì™„ë£Œ â€” ëª©ë¡ ê°±ì‹  ì¤‘...');

        // ì´ˆê¸°í™”
        document.getElementById('add-date').value = '';
        document.getElementById('add-title').value = '';
        document.getElementById('add-desc').value = '';
        document.getElementById('add-file').value = '';

        cancelAdd();
        await loadNotices();
      } catch (err) {
        console.error('submitNotice error:', err);
        alert('ê³µì§€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        debugEl('ë“±ë¡ ì˜¤ë¥˜ â€” ì½˜ì†” í™•ì¸');
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° ì´ˆê¸° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('class-confirm-btn').addEventListener('click', setClass);
      document.getElementById('back-btn').addEventListener('click', goBack);
      document.getElementById('add-general-btn').addEventListener('click', () => openAddForm('general'));
      document.getElementById('add-class-btn').addEventListener('click', () => openAddForm('class'));
      document.getElementById('submit-add-btn').addEventListener('click', submitNotice);
      document.getElementById('cancel-add-btn').addEventListener('click', cancelAdd);
      // ì—”í„°ë¡œ ë°˜ ì…ë ¥
      document.getElementById('class-input').addEventListener('keydown', e => { if (e.key === 'Enter') setClass(); });

      // ì´ˆê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      loadNotices().catch(err => { console.warn('ì´ˆê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err); debugEl('ì´ˆê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜ â€” ì½˜ì†” í™•ì¸'); });
    });
  </script>
</body>
</html>
