<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>중원고 알리미 개편</title>
  <style>
    body {font-family: Pretendard, sans-serif; margin: 30px;}
    .hidden {display: none;}
    .btn {padding: 6px 10px; border: none; border-radius: 6px; background: #2563eb; color: white; cursor: pointer;}
    .btn.danger {background: #dc2626;}
    .btn.muted {background: #6b7280;}
    .btn.ghost {background: transparent; border: 1px solid #9ca3af; color: #374151;}
    .stack-sm {margin-bottom: 10px;}
    .grid.two {display: grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    .section-head {display: flex; justify-content: space-between; align-items: center;}
    .file-preview img {max-width: 200px; margin-top: 5px; cursor: pointer;}
    .session-item {display: flex; gap: 6px; margin: 4px 0;}
  </style>
</head>

<body>
  <section id="main" class="container">
    <div class="grid two">
      <div>
        <div class="section-head"><h2>📅 행사 (전체공통)</h2></div>
        <div id="list-events"></div>
      </div>
      <div>
        <div class="section-head"><h2 id="assess-title">📝 수행평가</h2></div>
        <div id="list-assessments"></div>
      </div>
    </div>
    <h2 id="class-title">📣 반별 공지</h2>
    <div id="list-class"></div>
  </section>

  <!-- 작성/수정 폼 -->
  <section id="editor" class="container hidden">
    <h2 id="editor-title">새 글</h2>
    <div class="grid two">
      <div class="stack-sm">
        <label>카테고리</label>
        <select id="f-category">
          <option value="event">행사 (전체공통)</option>
          <option value="assessment">수행평가 (내용 공통)</option>
          <option value="class">반별 공지</option>
        </select>
      </div>
      <div class="stack-sm">
        <label>날짜</label>
        <input id="f-date" type="date" />
      </div>
    </div>

    <div class="grid two">
      <div class="stack-sm"><label>제목</label><input id="f-title" type="text" placeholder="제목" /></div>
      <div class="stack-sm"><label>첨부파일</label><input id="f-file" type="file" accept="image/*,.pdf" /></div>
    </div>

    <div class="stack-sm">
      <label>내용</label>
      <textarea id="f-desc" placeholder="내용"></textarea>
      <div id="file-preview" class="file-preview"></div>
    </div>

    <!-- 수행평가 공통 차시 입력 -->
    <div id="session-editor" class="hidden" style="margin-top:18px">
      <div class="section-head"><h3>공통 차시 정보 (+/-로 추가)</h3><span class="help">예시: 1차시 : 보고서 안내</span></div>
      <div id="session-list"></div>
      <div class="toolbar"><button id="btn-add-session" class="btn ghost">+ 차시 추가</button></div>
    </div>

    <div class="toolbar">
      <button id="btn-save" class="btn">저장</button>
      <button id="btn-cancel" class="btn muted">취소</button>
    </div>
  </section>

  <!-- 반별 차시 편집 -->
  <section id="session-panel" class="container hidden">
    <div class="section-head"><h2>차시 편집 (반별 비밀번호 필요)</h2><span class="badge" id="sp-assessment-title">-</span></div>
    <div id="class-session-list"></div>
    <div class="toolbar">
      <button id="sp-add" class="btn ghost">+ 차시 추가</button>
      <button id="sp-save" class="btn">저장</button>
      <button id="sp-cancel" class="btn muted">닫기</button>
    </div>
  </section>

  <div id="lightbox" class="lightbox hidden"><button class="btn">닫기</button><img alt="preview" /></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxyzwEpyLDxBjS9Wn2wjgzrphx4surn5g",
      authDomain: "jungwonjd2.firebaseapp.com",
      projectId: "jungwonjd2",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 기본 유틸 ---
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    let currentClass = null;
    let editContext = null;

    // 세션(공통)
    function addSessionRow(order='', text=''){
      const row = document.createElement('div');
      row.className='session-item';
      row.innerHTML = `
        <input type="number" class="s-order" placeholder="차시(숫자)" value="${order}">
        <input type="text" class="s-text" placeholder="활동 내용" value="${text}">
        <button class="btn danger" type="button">삭제</button>`;
      row.querySelector('button').addEventListener('click', ()=> row.remove());
      $('#session-list').appendChild(row);
    }
    $('#btn-add-session').addEventListener('click', ()=> addSessionRow());

    $('#f-category').addEventListener('change', e=>{
      const v=e.target.value;
      if(v==='assessment') $('#session-editor').classList.remove('hidden');
      else $('#session-editor').classList.add('hidden');
    });

    // --- 저장 로직 ---
    async function saveEditor(){
      const cat = $('#f-category').value;
      const date = $('#f-date').value?.trim();
      const title = $('#f-title').value?.trim();
      const description = $('#f-desc').value?.trim();
      if(!cat||!date||!title||!description) return alert('모든 항목을 입력하세요.');

      const base = { date, title, description, updatedAt: serverTimestamp() };
      if(cat==='assessment'){
        const sessions = collectSessionEditor();
        await addDoc(collection(db,'assessments'), {...base, createdAt: serverTimestamp(), defaultSessions: sessions});
      }
    }

    function collectSessionEditor(){
      const rows = [...$$('#session-list .session-item')];
      return rows.map(r=>({
        order: Number(r.querySelector('.s-order').value||0),
        text: r.querySelector('.s-text').value.trim()
      })).filter(x=>x.text);
    }

    // ===============================
    // 🔧 수정된 반별 차시 부분 (날짜/교시)
    // ===============================
    async function loadClassSessionsIntoPanel(assessment){
      const ref = doc(db,'assessments', assessment.id, 'sessions', currentClass);
      const sdoc = await getDoc(ref);
      const items = sdoc.exists() ? (sdoc.data().items||[]) : [];
      const box = $('#class-session-list');
      box.innerHTML = '';
      items.forEach(x=>{
        const row = document.createElement('div');
        row.className='session-item';
        row.innerHTML = `
          <input type="date" class="s-date" value="${x.date||''}">
          <input type="text" class="s-period" value="${x.period||''}" placeholder="예: 3교시">
          <button class="btn danger" type="button">삭제</button>`;
        row.querySelector('button').addEventListener('click', ()=> row.remove());
        box.appendChild(row);
      });
    }

    $('#sp-add').addEventListener('click', ()=>{
      const row = document.createElement('div');
      row.className='session-item';
      row.innerHTML = `
        <input type="date" class="s-date">
        <input type="text" class="s-period" placeholder="예: 4교시">
        <button class="btn danger" type="button">삭제</button>`;
      row.querySelector('button').addEventListener('click', ()=> row.remove());
      $('#class-session-list').appendChild(row);
    });

    $('#sp-save').addEventListener('click', async ()=>{
      if(!currentClass) return alert('반 선택 필요');
      const ok = await requireClassPasswordOnly(currentClass); // 이미 구현된 함수
      if(!ok) return;

      const items = [...$$('#class-session-list .session-item')]
        .map(r=>({
          date: r.querySelector('.s-date').value.trim(),
          period: r.querySelector('.s-period').value.trim()
        }))
        .filter(x=>x.date && x.period);

      const aid = $('#session-panel').dataset.assessmentId;
      await setDoc(doc(db,'assessments', aid, 'sessions', currentClass),
        {items, updatedAt: serverTimestamp()});
      alert('저장되었습니다.');
      $('#session-panel').classList.add('hidden');
      $('#main').classList.remove('hidden');
    });
  </script>
</body>
</html>
