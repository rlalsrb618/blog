<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¤‘ì›ê³  ê³µì§€ ì•Œë¦¬ë¯¸</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f5f8fc; margin:0; padding:20px; color:#333; }
header { text-align:center; padding:20px 0; background:#1c3c78; color:white }
.container { max-width:900px; margin:0 auto; }
h2 { border-bottom:2px solid #1c3c78; padding-bottom:5px; margin-top:40px; }
.card { background:white; padding:15px 20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; position:relative; }
.date { font-weight:bold; color:#1c3c78; }
.title { font-size:18px; margin:5px 0; }
.description { font-size:14px; color:#555; white-space:pre-wrap; }
.edit-btn, .delete-btn { position:absolute; top:15px; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; color:white; }
.edit-btn { right:70px; background:#1c3c78; } .delete-btn { right:15px; background:#c0392b; }
textarea,input{width:100%; box-sizing:border-box; margin-top:4px; font-family:inherit}
.hidden{display:none}
.add-btn{display:block; margin:20px auto; padding:10px 20px; background:#1c3c78; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer}
.add-btn:hover{background:#163063}
.back-btn{margin:15px 0; padding:8px 16px; background:#888; color:#fff; border:none; border-radius:6px; cursor:pointer}
.back-btn:hover{background:#555}
.file-preview{margin-top:10px} .file-preview img{max-width:200px;border-radius:6px;margin-top:5px;display:block}
.file-link{display:inline-block;margin-top:5px;color:#1c3c78;text-decoration:underline}
#debug { font-size:13px; color:#666; margin-top:8px; }
</style>
</head>
<body>
<header>
<h1>ì¤‘ì›ê³  í–‰ì‚¬Â·ìˆ˜í–‰í‰ê°€ ì•Œë¦¬ë¯¸</h1>
<p>ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”</p>
</header>

<div id="class-select" class="container">
<h2>ìì‹ ì˜ ë°˜ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
<p>ğŸ‘‰ ë„ì–´ì“°ê¸° ì—†ì´ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1í•™ë…„7ë°˜)</p>
<input type="text" id="class-input" placeholder="ì˜ˆ: 1í•™ë…„7ë°˜">
<button id="class-confirm-btn" class="add-btn">í™•ì¸</button>
<div id="debug">ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
</div>

<div id="main-container" class="container hidden">
<button id="back-btn" class="back-btn">â† ì´ì „ìœ¼ë¡œ</button>
<button id="add-general-btn" class="add-btn">+ ê³µì§€ ì¶”ê°€í•˜ê¸°</button>
<h2>ğŸ“… ì˜¤ëŠ˜ì˜ í–‰ì‚¬</h2>
<div id="notice-list"></div>
<h2 id="class-title">ğŸ“ ìˆ˜í–‰í‰ê°€</h2>
<button id="add-class-btn" class="add-btn">+ ìˆ˜í–‰í‰ê°€ ì¶”ê°€í•˜ê¸°</button>
<div id="class-notice-list"></div>
</div>

<div id="add-form" class="container hidden">
<h2>ğŸ“Œ ìƒˆ ê³µì§€ ì¶”ê°€</h2>
<input type="text" id="add-date" placeholder="ë‚ ì§œ (ì˜ˆ: 2025-07-25)">
<input type="text" id="add-title" placeholder="ì œëª©">
<textarea id="add-desc" placeholder="ë‚´ìš©"></textarea>
<input type="file" id="add-file" accept=".pdf,image/*">
<br><br>
<button id="submit-add-btn" class="add-btn">ë“±ë¡</button>
<button id="cancel-add-btn" class="back-btn">ì·¨ì†Œ</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const PASSWORD = "0922";
let currentClass = null;
let addingType = null;
const socket = io();

const debugEl = document.getElementById('debug');

const generalNotices = [];
const classNotices = {};

function debug(txt){ if(debugEl) debugEl.innerText = txt; }

function setClass(){
  const val = document.getElementById('class-input').value.replace(/\s+/g,'');
  if(!/^1í•™ë…„[1-9]ë°˜$/.test(val)){ alert('í˜•ì‹ ì˜¤ë¥˜'); return; }
  currentClass = val;
  document.getElementById('class-select').classList.add('hidden');
  document.getElementById('main-container').classList.remove('hidden');
  document.getElementById('class-title').innerText = `ğŸ“ ${currentClass} ìˆ˜í–‰í‰ê°€`;
  renderNotices();
}

function goBack(){ currentClass=null; document.getElementById('main-container').classList.add('hidden'); document.getElementById('class-select').classList.remove('hidden'); }

function openAddForm(type){
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if(pw!==PASSWORD){ alert('í‹€ë¦¼'); return; }
  if(type==='class' && !currentClass){ alert('ë°˜ ì„ íƒ í•„ìš”'); return; }
  addingType = type;
  document.getElementById('main-container').classList.add('hidden');
  document.getElementById('add-form').classList.remove('hidden');
}

function cancelAdd(){ addingType=null; document.getElementById('add-form').classList.add('hidden'); document.getElementById('main-container').classList.remove('hidden'); }

function makeCard(n,type){
  const card=document.createElement('div'); card.className='card';
  const date=document.createElement('div'); date.className='date'; date.innerText=n.date||''; card.appendChild(date);
  const title=document.createElement('div'); title.className='title'; title.innerText=n.title||''; card.appendChild(title);
  const desc=document.createElement('div'); desc.className='description'; desc.innerText=n.description||''; card.appendChild(desc);
  if(n.fileData){
    const fp=document.createElement('div'); fp.className='file-preview';
    if(n.fileType && n.fileType.startsWith('image/')) fp.innerHTML=`<img src="${n.fileData}" alt="${n.fileName||'ì´ë¯¸ì§€'}">`;
    else fp.innerHTML=`<a href="${n.fileData}" download="${n.fileName||'file'}" class="file-link">ğŸ“ ${n.fileName||'ì²¨ë¶€íŒŒì¼'}</a>`;
    card.appendChild(fp);
  }
  return card;
}

function renderNotices(){
  const nl=document.getElementById('notice-list'); nl.innerHTML='';
  generalNotices.slice().reverse().forEach(n=>nl.appendChild(makeCard(n,'general')));
  const cl=document.getElementById('class-notice-list'); cl.innerHTML='';
  const arr=(currentClass && classNotices[currentClass])?classNotices[currentClass]:[];
  arr.slice().reverse().forEach(n=>cl.appendChild(makeCard(n,'class')));
}

async function submitNotice(){
  const date=document.getElementById('add-date').value.trim();
  const title=document.getElementById('add-title').value.trim();
  const desc=document.getElementById('add-desc').value.trim();
  if(!date||!title||!desc){ alert('ëª¨ë‘ ì…ë ¥'); return; }
  let fileData=null, fileName='', fileType='';
  const fileInput=document.getElementById('add-file');
  if(fileInput.files.length>0){
    const file=fileInput.files[0];
    fileName=file.name; fileType=file.type;
    fileData=await new Promise(resolve=>{
      const reader=new FileReader(); reader.onload=e=>resolve(e.target.result); reader.readAsDataURL(file);
    });
  }
  const payload={ type:addingType, date, title, description:desc, fileData, fileName, fileType, className: addingType==='class'?currentClass:null };
  socket.emit('addNotice', payload);
  cancelAdd();
}

document.getElementById('class-confirm-btn').onclick=setClass;
document.getElementById('back-btn').onclick=goBack;
document.getElementById('add-general-btn').onclick=()=>openAddForm('general');
document.getElementById('add-class-btn').onclick=()=>openAddForm('class');
document.getElementById('cancel-add-btn').onclick=cancelAdd;
document.getElementById('submit-add-btn').onclick=submitNotice;

// Socket.IO ì´ë²¤íŠ¸
socket.on('loadNotices', notices=>{
  generalNotices.length=0; for(const n of notices) if(n.type==='general') generalNotices.push(n);
  classNotices={} 
  for(const n of notices){ if(n.type==='class'){ const c=n.className||'unknown'; if(!classNotices[c]) classNotices[c]=[]; classNotices[c].push(n); }}
  renderNotices();
});
socket.on('newNotice', n=>{
  if(n.type==='general') generalNotices.unshift(n);
  else { const c=n.className||'unknown'; if(!classNotices[c]) classNotices[c]=[]; classNotices[c].unshift(n); }
  renderNotices();
});
</script>
</body>
</html>

// server.js
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const mongoose = require('mongoose');
const path = require('path');
const multer = require('multer');

const app = express();
const server = http.createServer(app);
const io = new Server(server);

const upload = multer({ storage: multer.memoryStorage() });
app.use(express.json({ limit: '10mb' }));
app.use(express.static(path.join(__dirname, 'public')));

// MongoDB ì—°ê²°
mongoose.connect('mongodb://localhost:27017/noticeApp', {
  useNewUrlParser: true,
  useUnifiedTopology: true
}).then(() => console.log('MongoDB connected'))
  .catch(err => console.error(err));

// ê³µì§€ ìŠ¤í‚¤ë§ˆ
const noticeSchema = new mongoose.Schema({
  type: String, // general or class
  className: String,
  date: String,
  title: String,
  description: String,
  fileData: String,
  fileName: String,
  fileType: String,
  createdAt: { type: Date, default: Date.now }
});
const Notice = mongoose.model('Notice', noticeSchema);

// Socket.IO ì—°ê²°
io.on('connection', socket => {
  console.log('ì‚¬ìš©ì ì—°ê²°');

  // ê³µì§€ ì´ˆê¸° ë¡œë“œ
  Notice.find().sort({ createdAt: -1 }).then(notices => {
    socket.emit('loadNotices', notices);
  });

  // ìƒˆë¡œìš´ ê³µì§€
  socket.on('addNotice', async (data) => {
    try {
      const notice = new Notice(data);
      const saved = await notice.save();
      io.emit('newNotice', saved);
    } catch (err) {
      socket.emit('error', { message: 'ê³µì§€ ë“±ë¡ ì‹¤íŒ¨', error: err });
    }
  });

  socket.on('disconnect', () => console.log('ì‚¬ìš©ì ì—°ê²° ì¢…ë£Œ'));
});

// ì„œë²„ ì‹¤í–‰
const PORT = 3000;
server.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));
